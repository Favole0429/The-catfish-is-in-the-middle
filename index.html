<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é²¶é±¼é“¾æ¥æµ‹è¯•ä¸­â™¡</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* =================================================================
           ã€æ¨¡å—ï¼šå…¨å±€å˜é‡ã€‘
           ================================================================= */
        :root {
            --c-theme: #E24B2A;       
            --c-bg-main: #ffffff;     
            --c-bg-sub: #ffffff;      
            --c-border: rgba(0,0,0,0.08); 
            --c-icon: #666666;        
            
            --bubble-me-bg: var(--c-theme);
            --bubble-me-text: #ffffff;
            --bubble-other-bg: #f2f2f7; 
            --bubble-other-text: #000000;

            --text-main: #1a1a1a;
            --text-sub: #888888;
            
            --input-bg: #f9f9f9;      
            
            --chat-font-size: 16px;   
            --global-font-family: "PingFang SC", "Microsoft YaHei", sans-serif; 
        }

        /* =================================================================
           ã€æ¨¡å—ï¼šå…¨å±€é»‘å¤œæ¨¡å¼ (æ·±åº¦é€‚é…)ã€‘
           ================================================================= */
        body.dark-mode {
            --c-bg-main: #000000; 
            --c-bg-sub: #1c1c1e;
            --c-border: #333333; 
            --c-icon: #aaaaaa;
            --bubble-other-bg: #2c2c2e; 
            --bubble-other-text: #ffffff;
            --text-main: #ffffff; 
            --text-sub: #8e8e93;
            --input-bg: #1c1c1e;
        }

        /* å¼¹çª—ã€èœå•ã€ä¾§è¾¹æ æ·±åº¦å˜é»‘ */
        body.dark-mode .modal-content,
        body.dark-mode .action-menu,
        body.dark-mode .reply-main,
        body.dark-mode .add-category-btn {
            background-color: #1c1c1e !important;
            color: #ffffff;
            border-color: #333 !important;
        }

        /* ä¾§è¾¹æ ç¨æ·±ä¸€ç‚¹ */
        body.dark-mode .reply-sidebar {
            background-color: #151517 !important;
            border-right-color: #333 !important;
        }

        /* æ–‡å­—é¢œè‰²å¼ºåˆ¶åç™½ */
        body.dark-mode .modal-header,
        body.dark-mode .setting-title,
        body.dark-mode .section-title,
        body.dark-mode h3, 
        body.dark-mode h4,
        body.dark-mode .menu-item,
        body.dark-mode .song-title-m,
        body.dark-mode details summary {
            color: #ffffff !important;
        }

        body.dark-mode .song-artist-m,
        body.dark-mode .category-item {
            color: #aaaaaa !important;
        }

        /* è¾“å…¥æ¡†å˜é»‘ */
        body.dark-mode .info-input,
        body.dark-mode .code-editor,
        body.dark-mode textarea {
            background-color: #2c2c2e !important;
            color: #ffffff !important;
            border-color: #333 !important;
        }

        /* åˆ—è¡¨é¡¹ã€Chip å˜é»‘ */
        body.dark-mode .category-item.active,
        body.dark-mode .reply-chip,
        body.dark-mode .session-item.active {
            background-color: #2c2c2e !important;
            color: var(--c-theme) !important;
            border-color: #333 !important;
        }
        
        body.dark-mode .reply-chip {
            color: #fff !important;
        }

        body.dark-mode .category-item:hover:not(.active),
        body.dark-mode .session-item:hover,
        body.dark-mode .menu-item:hover {
            background-color: rgba(255,255,255,0.1) !important;
        }

        /* è£…æ‰®ä¸­å¿ƒåŒºå—å˜é»‘ */
        body.dark-mode .section-group {
            background-color: #2c2c2e !important;
            border-color: #333 !important;
        }
        
        /* é’ˆå¯¹æµ…è“è‰²å¯¼å…¥åŒºçš„ç‰¹æ®Šé€‚é… */
        body.dark-mode div[style*="background:#f0f8ff"] {
            background-color: #1a202c !important;
            border-color: #2c5282 !important;
        }
        body.dark-mode div[style*="background:#f0f8ff"] .section-title {
            color: #63b3ed !important;
        }

        /* æ’­æ”¾åˆ—è¡¨å˜é»‘ */
        body.dark-mode .playlist-box {
            background-color: #000000 !important;
            border-color: #333 !important;
        }
        body.dark-mode .playlist-item {
            color: #ddd !important;
            border-bottom-color: #333 !important;
        }
        body.dark-mode .playlist-item:hover {
            background-color: #2c2c2e !important;
        }
        body.dark-mode .playlist-item.active {
            background-color: #2c2c2e !important;
            color: var(--c-theme) !important;
        }

        /* æ§åˆ¶æŒ‰é’®å˜ç™½ */
        body.dark-mode .ctrl-btn {
            color: #ffffff !important;
        }
        
        /* å­—ä½“å¤§å°æ»‘å—èƒŒæ™¯ */
        body.dark-mode div[style*="background:#fff"] {
            background-color: #2c2c2e !important;
            border-color: #333 !important;
        }
        body.dark-mode span[style*="color:#333"] {
            color: #fff !important;
        }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }
        ::-webkit-scrollbar { display:none; }

        body {
            font-family: var(--global-font-family); 
            background-color: var(--c-bg-main);
            background-image: var(--bg-image); background-size: cover; background-attachment: fixed;
            color: var(--text-main); height: 100vh; width: 100vw; overflow: hidden;
            display: flex; justify-content: center; transition: background-color 0.3s;
            font-size: 15px; 
        }

        #app { width: 100%; max-width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }

        /* ç»„ä»¶æ ·å¼ */
        .theme-preset-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .theme-preset-item:hover { background: rgba(0,0,0,0.05); }
        .theme-preset-item.active { border-color: var(--c-theme); background: rgba(0,0,0,0.03); }
        .color-preview { width: 40px; height: 40px; border-radius: 50%; display: flex; overflow: hidden; border: 2px solid #ddd; transform: rotate(45deg); }
        .cp-slice { flex: 1; height: 100%; }

        header { padding: 0 15px; height: 110px; background: var(--c-bg-main); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--c-border); z-index: 100; transition: background-color 0.3s; }
        .header-avatars img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--c-theme); margin-right: -12px; background: #ddd; }
        .header-avatars img:last-child { margin-right: 0; }
        .header-title { flex: 1; text-align: center; font-size: 0.9rem; color: var(--text-sub); font-weight: bold; }
        .menu-btn { font-size: 28px; color: var(--c-icon); cursor: pointer; }

        /* èŠå¤©åŒºåŸŸå¸ƒå±€ */
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; }
        .message-row { display: flex; align-items: flex-start; gap: 8px; max-width: 100%; animation: fadeIn 0.2s ease-out; flex-shrink: 0; margin-bottom: 15px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .bubble-container { display: flex; flex-direction: column; max-width: calc(100% - 60px); }
        .message-row.left .bubble-container { align-items: flex-start; }
        .message-row.right .bubble-container { align-items: flex-end; }
        .message-row.left { align-self: flex-start; }
        .message-row.right { align-self: flex-end; flex-direction: row-reverse; }
        .chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer; }
        .chat-avatar.shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-5deg); } 20%, 80% { transform: translate3d(2px, 0, 0) rotate(5deg); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-10deg); } 40%, 60% { transform: translate3d(4px, 0, 0) rotate(10deg); } }
        
        /* éšè—å¤´åƒæ ·å¼ */
        body.hide-avatars .chat-avatar { display: none !important; }
        body.hide-avatars .message-row { gap: 0; }
        body.hide-avatars .bubble-container { max-width: 85%; }
        body.hide-avatars .message-row.left .bubble-container { margin-left: 5px; }
        body.hide-avatars .message-row.right .bubble-container { margin-right: 5px; }
        body.hide-avatars .typing-indicator { margin-left: 5px; }

        .bubble { padding: 10px 14px; border-radius: 12px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height: 1.5; font-size: var(--chat-font-size); word-break: break-word; min-height: 40px; display: flex; align-items: center; }
        .left .bubble { background: var(--bubble-other-bg); color: var(--bubble-other-text); border-bottom-left-radius: 2px; }
        .right .bubble { background: var(--bubble-me-bg); color: var(--bubble-me-text); border-bottom-right-radius: 2px; }
        .bubble img { max-width: 100%; border-radius: 8px; display: block; }
        .meta-info { font-size: 10px; opacity: 0.5; margin-top: 3px; display: flex; align-items: center; gap: 4px; }
        
        .system-msg { align-self: center; font-size: 11px; color: #888; background: rgba(0,0,0,0.05); padding: 4px 12px; border-radius: 999px; margin: 10px auto; width: fit-content; max-width: 80%; text-align: center; flex-shrink: 0; }

        .typing-indicator { display: none; align-self: flex-start; background: var(--bubble-other-bg); padding: 12px 16px; border-radius: 18px; border-bottom-left-radius: 4px; margin-left: 48px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); width: fit-content; flex-shrink: 0; margin-bottom: 15px; }
        .typing-dots { display: flex; gap: 4px; align-items: center; height: 10px; }
        .typing-dot { width: 6px; height: 6px; background-color: var(--c-theme); border-radius: 50%; opacity: 0.6; animation: wave 1.3s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes wave { 0%, 100% { transform: translateY(0); opacity: 0.6; } 50% { transform: translateY(-4px); opacity: 1; } }

        #input-area { background: var(--c-bg-main); padding: 10px 10px 30px 10px; border-top: 1px solid var(--c-border); z-index: 100; transition: background-color 0.3s; box-shadow: 0 -2px 10px rgba(0,0,0,0.02); }
        .input-row { display: flex; align-items: flex-end; gap: 10px; position: relative; }
        .btn-plus { font-size: 32px; color: var(--c-icon); padding: 5px; cursor: pointer; transition: 0.3s; }
        .btn-plus.rotate { transform: rotate(45deg); color: var(--c-theme); }
        #msg-input { flex: 1; background: var(--input-bg); border: 1px solid var(--c-border); border-radius: 24px; padding: 10px 15px; font-size: 16px; max-height: 120px; resize: none; color: var(--text-main); }
        .btn-magic { font-size: 28px; color: var(--c-icon); padding: 5px; cursor: pointer; }
        .btn-send { width: 40px; height: 40px; background: var(--c-theme); color: #fff; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }

        .action-menu { position: absolute; bottom: 80px; left: 10px; background: #ffffff; border-radius: 16px; padding: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); display: none; flex-direction: column; gap: 5px; width: 160px; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; border: 1px solid rgba(0,0,0,0.05); }
        .action-menu.show { display: flex; }
        .menu-item { display: flex; align-items: center; gap: 10px; font-size: 14px; padding: 10px 12px; cursor: pointer; color: var(--text-main); border-radius: 10px; transition: background 0.2s; }
        .menu-item:hover { background: rgba(0,0,0,0.05); }
        .menu-item i { font-size: 18px; color: var(--c-theme); }
        .switch-wrapper { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .toggle-switch { position: relative; width: 36px; height: 20px; background: #ccc; border-radius: 20px; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .toggle-switch.checked { background: var(--c-theme); }
        .toggle-switch.checked::after { left: 18px; }
        @keyframes popUp { from{transform:scale(0.8);opacity:0;translate:0 20px} to{transform:scale(1);opacity:1;translate:0 0} }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #ffffff; width: 85%; max-width: 360px; border-radius: 24px; padding: 25px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* è¯æ¡åº“ä¸“ç”¨å…¨å±æ ·å¼ */
        #modal-replies .modal-content { max-width: 500px; padding: 0; height: 70vh; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }
        #modal-replies.fullscreen .modal-content { width: 100%; height: 100%; max-width: 100%; border-radius: 0; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; font-size: 18px; font-weight: bold; color: #333; }
        .modal-header i { cursor: pointer; padding: 5px; color: #999; }
        
        .reply-container { display: flex; height: 100%; }
        .reply-sidebar { width: 30%; background: #f7f7f7; border-right: 1px solid #eee; overflow-y: auto; padding: 10px 0; display: flex; flex-direction: column; }
        .category-list { flex: 1; overflow-y: auto; }
        .category-item { padding: 12px 15px; font-size: 14px; color: #666; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
        .category-item.active { background: #fff; color: var(--c-theme); border-left-color: var(--c-theme); font-weight: bold; }
        .category-item:hover:not(.active) { background: #f0f0f0; }
        
        .reply-main { flex: 1; padding: 15px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; }
        .reply-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .reply-header h4 { margin: 0; font-size: 16px; color: #333; }
        
        .reply-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .reply-chip { background: #f9f9f9; border: 1px solid #eee; padding: 6px 12px; border-radius: 20px; font-size: 13px; color: #333; cursor: default; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .reply-chip:hover { border-color: var(--c-theme); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chip-del { color: #ccc; cursor: pointer; font-size: 14px; }
        .chip-del:hover { color: #ff4d4f; }

        .add-category-btn { border-top: 1px solid #eee; padding: 12px; text-align: center; font-size: 13px; color: var(--c-theme); cursor: pointer; background: #fff; font-weight: bold; }
        .add-category-btn:hover { background: #f9f9f9; }

        .session-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .session-item:hover { background: #f9f9f9; }
        .session-item.active { background: rgba(0,0,0,0.03); font-weight: bold; color: var(--c-theme); }

        #music-float { position: fixed; bottom: 120px; right: 20px; width: 48px; height: 48px; background: var(--c-bg-sub); border-radius: 50%; border: 2px solid var(--c-theme); display: none; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 900; animation: spin 5s linear infinite; cursor: pointer; }
        #music-float img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #splash { position: fixed; inset: 0; background: var(--c-bg-main); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s; }
        #splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .splash-icon { font-size: 80px; color: var(--c-theme); margin-bottom: 20px; animation: floatY 3s infinite; }
        @keyframes floatY { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }

        .setting-row { margin-bottom: 20px; }
        .setting-title { font-size: 14px; color: #666; margin-bottom: 8px; display: block; font-weight: 500; }
        .btn-block { display: block; width: 100%; padding: 12px; background: var(--c-theme); color: #fff; border:none; border-radius: 12px; margin-top: 15px; cursor: pointer; font-size: 15px; font-weight: bold; transition: opacity 0.2s; }
        .btn-block:active { opacity: 0.8; }
        .btn-outline { display: block; width: 100%; padding: 10px; border: 1px solid var(--c-theme); color: var(--c-theme); background:none; border-radius: 12px; margin-top: 8px; cursor: pointer; font-size: 14px; }
        .code-editor { width: 100%; height: 180px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 12px; padding: 12px; font-family: monospace; font-size: 12px; resize: vertical; line-height: 1.5; outline: none; }
        .info-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; background: #f9f9f9; color: #333; font-size: 14px; outline: none; transition: border 0.2s; }
        .info-input:focus { border-color: var(--c-theme); background: #fff; }
        .info-avatar-upload { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--c-theme); object-fit: cover; margin: 0 auto 10px; display: block; cursor: pointer; }

        /* =================================================================
           ã€æ¨¡å—ï¼šæ–°ç‰ˆç®€çº¦æ’­æ”¾å™¨æ ·å¼ (å‡çº§ç‰ˆ)ã€‘
           ================================================================= */
        .modern-player {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .player-visual {
            width: 200px;
            height: 200px;
            margin-bottom: 20px;
            position: relative;
            /* ç§»é™¤åŸæœ¬çš„ç¼©æ”¾è¿‡æ¸¡ï¼Œæ”¹ç”¨æ—‹è½¬ */
        }
        /* åœ†å½¢æ—‹è½¬å°é¢ */
        .player-cover {
            width: 100%;
            height: 100%;
            border-radius: 50%; /* å˜æˆåœ†å½¢ */
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 2;
            position: relative;
            border: 4px solid var(--c-bg-sub); /* å¢åŠ ä¸€ç‚¹å”±ç‰‡è¾¹æ¡†æ„Ÿ */
            /* æ—‹è½¬åŠ¨ç”»é…ç½® */
            animation: spinVinyl 10s linear infinite;
            animation-play-state: paused; /* é»˜è®¤æš‚åœ */
        }
        /* æ’­æ”¾æ—¶æ—‹è½¬ */
        .player-visual.playing .player-cover {
            animation-play-state: running;
            box-shadow: 0 15px 40px rgba(var(--c-theme-rgb), 0.3);
        }
        
        @keyframes spinVinyl {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .player-info-modern {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
        }
        .song-title-m {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .song-artist-m {
            font-size: 14px;
            color: #888;
        }
        
        /* æ­Œè¯åŒºåŸŸ */
        .lyrics-container {
            height: 40px;
            width: 100%;
            overflow: hidden;
            margin-bottom: 15px;
            text-align: center;
            position: relative;
        }
        .lyrics-content {
            font-size: 13px;
            color: var(--c-theme);
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            opacity: 0.8;
        }

        .progress-container {
            width: 100%;
            margin-bottom: 20px;
        }
        .progress-bar-bg {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--c-theme);
            width: 0%;
            transition: width 0.1s linear;
            border-radius: 4px;
        }
        .time-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 11px;
            color: #999;
            font-family: monospace;
        }
        .controls-modern {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        .ctrl-btn {
            color: #333;
            font-size: 24px;
            cursor: pointer;
            transition: 0.2s;
        }
        .ctrl-btn:hover { color: var(--c-theme); transform: scale(1.1); }
        .play-btn-large {
            width: 64px;
            height: 64px;
            background: var(--c-theme);
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: 0.2s;
        }
        .play-btn-large:active { transform: scale(0.95); }
        
        .player-tools {
            width: 100%;
            border-top: 1px solid #f5f5f5;
            padding-top: 15px;
        }
        .tool-header {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
        }
        .tool-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        .tool-content.show { display: block; }
        
        /* æ’­æ”¾åˆ—è¡¨æ ·å¼ */
        .playlist-box {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .playlist-item {
            padding: 8px 10px;
            font-size: 13px;
            color: #555;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .playlist-item:last-child { border-bottom: none; }
        .playlist-item:hover { background: #fff; }
        .playlist-item.active {
            color: var(--c-theme);
            font-weight: bold;
            background: #fff;
        }
        .playlist-empty {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 12px;
        }
        
        /* è£…æ‰®ä¸­å¿ƒä¼˜åŒ–æ ·å¼ */
        .section-group {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }
        .section-title {
            font-size: 13px;
            font-weight: bold;
            color: #555;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .section-title i { color: var(--c-theme); font-size: 16px; }
        
        details summary {
            cursor: pointer;
            font-size: 13px;
            color: #666;
            padding: 10px 0;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
        }
        details summary::after {
            content: '+';
            font-size: 16px;
            color: #999;
        }
        details[open] summary::after {
            content: '-';
        }

    </style>
</head>
<body>

    <!-- å¼€å± -->
    <div id="splash">
        <i class="ph-fill ph-heart splash-icon"></i>
        <div style="font-size:1.5rem;font-weight:bold;margin-top:10px;color:var(--c-theme)">å¯çˆ±é²¶é±¼è‡ªæ€ä¸­â™¡</div>
    </div>

    <!-- éŸ³ä¹æ‚¬æµ®çª— -->
    <div id="music-float" onclick="openPlayer()">
        <img id="float-img" src="https://api.dicebear.com/7.x/identicon/svg?seed=Music">
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="app">
        <header>
            <div class="header-avatars" onclick="openPlayer()">
                <img id="head-av-other" src="">
                <img id="head-av-self" src="">
            </div>
            <div class="header-title" id="header-quote">å¯¹æ–¹</div>
            <div class="menu-btn" onclick="openMenu()"><i class="ph ph-list"></i></div>
        </header>

        <div id="chat-area">
            <div class="system-msg">ä¸‹æ‹‰åŠ è½½æ›´å¤š...</div>
            <div id="msg-list"></div>
            <div class="typing-indicator" id="typing-indicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>

        <div id="input-area">
            <input type="file" id="file-img" hidden accept="image/*">
            
            <div class="action-menu" id="action-menu">
                <div class="menu-item" onclick="triggerUpload('img')">
                    <i class="ph ph-image"></i> å‘é€å›¾ç‰‡
                </div>
                <div class="menu-item" onclick="togglePatSwitch(event)">
                    <div class="switch-wrapper">
                        <span><i class="ph ph-hand-tap"></i> æ‹ä¸€æ‹</span>
                        <div class="toggle-switch" id="pat-switch"></div>
                    </div>
                </div>
                <div class="menu-item" onclick="openPatSettings()">
                    <i class="ph ph-pencil-simple"></i> è®¾ç½®æ‹ä¸€æ‹
                </div>
                <div class="menu-item" onclick="openSessions()">
                    <i class="ph ph-chats"></i> ä¼šè¯ç®¡ç†
                </div>
                <div class="menu-item" onclick="clearChat()">
                    <i class="ph ph-trash"></i> æ¸…ç©ºè®°å½•
                </div>
            </div>

            <div class="input-row">
                <i class="ph ph-plus-circle btn-plus" id="btn-plus" onclick="toggleMenu()"></i>
                <textarea id="msg-input" rows="1"></textarea>
                <i class="ph ph-sparkle btn-magic" onclick="autoReply()"></i>
                <button class="btn-send" onclick="sendMsg()"><i class="ph-bold ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—èœå• -->
    <div id="modal-menu" class="modal" onclick="if(event.target==this) closeAllModals()">
        <div class="modal-content" style="width:200px; position:absolute; top:70px; right:10px; padding:10px;">
            <div class="menu-item" onclick="openRoleInfo('other')"><i class="ph ph-user"></i> è§’è‰²ä¿¡æ¯</div>
            <div class="menu-item" onclick="openRoleInfo('self')"><i class="ph ph-identification-card"></i> ä¸ªäººä¿¡æ¯</div>
            <div class="menu-item" onclick="openSettings()"><i class="ph ph-paint-brush"></i> è£…æ‰®ä¸­å¿ƒ</div>
            <div class="menu-item" onclick="openReplies()"><i class="ph ph-book-bookmark"></i> è¯æ¡åº“</div>
        </div>
    </div>

    <!-- æ‹ä¸€æ‹è‡ªå®šä¹‰å¼¹çª— -->
    <div id="modal-pat" class="modal">
        <div class="modal-content" style="padding:25px;">
            <div class="modal-header">
                <span>æ‹ä¸€æ‹è‡ªå®šä¹‰</span>
                <i class="ph ph-x" onclick="closeAllModals()"></i>
            </div>
            <div class="setting-row">
                <span class="setting-title">æˆ‘æ‹å¯¹æ–¹æ—¶çš„åç¼€</span>
                <input type="text" id="pat-self-input" class="info-input" placeholder="ä¾‹å¦‚ï¼šçš„è„‘è¢‹">
            </div>
            <div class="setting-row">
                <span class="setting-title">å¯¹æ–¹æ‹æˆ‘æ—¶çš„åç¼€</span>
                <input type="text" id="pat-other-input" class="info-input" placeholder="ä¾‹å¦‚ï¼šçš„è‚©è†€">
            </div>
            <button class="btn-block" onclick="savePatSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- è§’è‰²/ä¸ªäººä¿¡æ¯å¼¹çª— -->
    <div id="modal-role" class="modal">
        <div class="modal-content" style="padding:25px;">
            <div class="modal-header"><h3 id="role-title">ä¿¡æ¯ç¼–è¾‘</h3><i class="ph ph-x" onclick="closeAllModals()"></i></div>
            <div style="text-align:center;">
                <img id="role-av-img" class="info-avatar-upload" onclick="changeRoleAvatar()">
                <div style="font-size:12px;color:#888;margin-bottom:15px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
            </div>
            <div class="setting-row">
                <span class="setting-title">å§“å / å¤‡æ³¨</span>
                <input type="text" id="role-name" class="info-input" placeholder="è¾“å…¥åå­—...">
            </div>
            <div class="setting-row">
                <span class="setting-title">è¯¦ç»†ä¿¡æ¯ (äººè®¾/ç®€ä»‹)</span>
                <textarea id="role-desc" class="info-input" rows="4" placeholder="å¡«å†™è¯¦ç»†ä¿¡æ¯..."></textarea>
            </div>
            <button class="btn-block" onclick="saveRoleInfo()">ä¿å­˜ä¿¡æ¯</button>
        </div>
    </div>

    <!-- è£…æ‰®ä¸­å¿ƒ - é‡æ–°æ•´ç†ç‰ˆ -->
    <div id="modal-settings" class="modal">
        <div class="modal-content" style="padding:25px;">
            <div class="modal-header"><h3>è£…æ‰®ä¸­å¿ƒ</h3><i class="ph ph-x" onclick="closeAllModals()"></i></div>
            
            <!-- 1. é¢„è®¾ä¸»é¢˜ -->
            <div class="section-group">
                <div class="section-title"><i class="ph-palette"></i> å¿«é€Ÿåˆ‡æ¢ä¸»é¢˜</div>
                <div id="theme-list" style="display:flex; flex-direction:column; gap:8px;"></div>
                <!-- ã€æ–°å¢ã€‘ä¿å­˜é¢„è®¾æŒ‰é’® -->
                <button class="btn-outline" style="width:100%; margin-top:10px; border-style:dashed;" onclick="saveThemePreset()">+ ä¿å­˜å½“å‰è£…æ‰®ä¸ºé¢„è®¾</button>
            </div>

            <!-- 2. æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¼å…¥çš®è‚¤ -->
            <div class="section-group" style="background:#f0f8ff; border-color:#d1e9ff;">
                <div class="section-title" style="color:#0056b3;"><i class="ph-magic-wand"></i> å¯¼å…¥çš®è‚¤ä»£ç  (CSS/é…ç½®)</div>
                <textarea id="import-theme-input" class="info-input" placeholder="ç²˜è´´ä»åˆ«å¤„å¤åˆ¶çš„çš®è‚¤ä»£ç ..." style="background:#fff; height: 100px; font-family: monospace; font-size: 12px; border:1px solid #cce5ff;"></textarea>
                <button class="btn-block" style="margin-top:10px; font-size:14px;" onclick="importThemeFromCode()">ç«‹å³åº”ç”¨çš®è‚¤</button>
            </div>

            <!-- 3. ä¸ªæ€§åŒ–å¾®è°ƒ (æŠ˜å ) -->
            <details class="section-group" style="padding: 10px 15px;">
                <summary>æ›´å¤šä¸ªæ€§åŒ–è®¾ç½® (å­—ä½“/å£çº¸/å¼€å…³)</summary>
                <div style="margin-top:15px;">
                    <div class="setting-row">
                        <span class="setting-title">å­—ä½“å¤§å°</span>
                        <div style="display:flex; align-items:center; gap:10px; background:#fff; padding:10px; border-radius:10px; border:1px solid #eee;">
                            <span style="font-size:12px; color:#666; width:40px;">å¤§å°</span>
                            <input type="range" id="font-size-slider" min="12" max="24" step="1" style="flex:1" oninput="updateFontSize(this.value)">
                            <span id="font-size-display" style="font-size:12px; color:#333; width:30px; text-align:right;">16</span>
                        </div>
                    </div>
                    
                    <div class="setting-row">
                        <span class="setting-title">è‡ªå®šä¹‰å­—ä½“</span>
                        <input type="text" id="font-url-input" class="info-input" placeholder="å­—ä½“é“¾æ¥ (URL)...">
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button class="btn-outline" style="flex:1" onclick="loadFontFromUrl()">ç½‘ç»œå­—ä½“</button>
                            <input type="file" id="font-file-input" hidden accept=".ttf,.otf,.woff,.woff2">
                            <button class="btn-outline" style="flex:1" onclick="document.getElementById('font-file-input').click()">æœ¬åœ°æ–‡ä»¶</button>
                            <!-- ã€æ–°å¢ã€‘æ¸…é™¤å­—ä½“æŒ‰é’® -->
                            <button class="btn-outline" style="flex:0 0 auto; width:auto; padding:0 15px; color:#666; border-color:#ccc;" onclick="clearCustomFont()">ğŸ—‘ï¸ æ¢å¤é»˜è®¤</button>
                        </div>
                    </div>

                    <div class="setting-row">
                        <span class="setting-title">åŠŸèƒ½å¼€å…³</span>
                        <!-- ã€æ–°å¢ã€‘æ·±è‰²æ¨¡å¼å¼€å…³ -->
                        <div class="menu-item" onclick="toggleSetting('darkMode')" style="justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                            <span>ğŸŒ™ æ·±è‰²æ¨¡å¼</span>
                            <div class="toggle-switch" id="switch-darkMode"></div>
                        </div>
                        <div class="menu-item" onclick="toggleSetting('showAvatar')" style="justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                            <span>æ˜¾ç¤ºå¤´åƒ</span>
                            <div class="toggle-switch" id="switch-showAvatar"></div>
                        </div>
                        <div class="menu-item" onclick="toggleSetting('showFloat')" style="justify-content: space-between; padding: 10px 0;">
                            <span>æ˜¾ç¤ºéŸ³ä¹æ‚¬æµ®çª—</span>
                            <div class="toggle-switch" id="switch-showFloat"></div>
                        </div>
                    </div>

                    <div class="setting-row">
                        <span class="setting-title">èŠå¤©èƒŒæ™¯</span>
                        <input type="file" id="file-bg" hidden accept="image/*">
                        <button class="btn-outline" onclick="document.getElementById('file-bg').click()">ä¸Šä¼ å£çº¸</button>
                        <button class="btn-outline" style="color:#999;border-color:#ccc;margin-top:5px;" onclick="updateStyle('bg', '')">ç§»é™¤å£çº¸</button>
                    </div>
                </div>
            </details>

            <!-- 4. å¯¼å‡ºé…ç½® (æŠ˜å ) -->
            <details class="section-group" style="padding: 10px 15px;">
                <summary>æŸ¥çœ‹/å¯¼å‡ºå½“å‰é…ç½®ä»£ç </summary>
                <div style="margin-top:15px;">
                    <textarea id="custom-code" class="code-editor" placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆä»£ç ..."></textarea>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button class="btn-outline" style="flex:1" onclick="generateThemeCode()">ç”Ÿæˆä»£ç </button>
                        <button class="btn-block" style="flex:1; margin-top:5px;" onclick="applyCustomTheme()">æµ‹è¯•åº”ç”¨</button>
                    </div>
                </div>
            </details>

            <!-- ã€æ–°å¢ã€‘é‡ç½®è£…æ‰®æŒ‰é’® -->
            <div style="display:flex; gap:10px;">
                <button class="btn-outline" style="flex:1; color:#ff4d4f; border-color:#ff4d4f;" onclick="resetToDefaultTheme()">ğŸ”´ é‡ç½®æ‰€æœ‰è£…æ‰®</button>
                <button class="btn-block" style="flex:1; margin-top:0;" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- ã€é‡æ„ã€‘é«˜ç«¯ç®€çº¦æ’­æ”¾å™¨ (å¸¦æ’­æ”¾åˆ—è¡¨/æ­Œè¯/åœ†å½¢å°é¢) -->
    <div id="modal-player" class="modal">
        <div class="modal-content" style="padding:30px 25px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);">
            <div class="modal-header" style="margin-bottom:10px; border:none;">
                <span style="font-size:14px; color:#999; letter-spacing:1px; text-transform:uppercase;">Now Playing</span>
                <i class="ph ph-x" onclick="closeAllModals()"></i>
            </div>
            
            <div class="modern-player">
                <!-- ä¸“è¾‘å°é¢ (åœ†å½¢+æ—‹è½¬) -->
                <div class="player-visual" id="player-visual">
                    <img id="player-cover-img" class="player-cover" src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=300">
                </div>
                
                <!-- æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="lyrics-container">
                    <div id="lyric-text" class="lyrics-content">æš‚æ— æ­Œè¯</div>
                </div>

                <!-- ä¿¡æ¯ -->
                <div class="player-info-modern">
                    <div class="song-title-m" id="song-name">æœªæ’­æ”¾</div>
                    <div class="song-artist-m">Music Player</div>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div class="progress-container">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progress-fill"></div>
                    </div>
                    <div class="time-labels">
                        <span id="curr-time">0:00</span>
                        <span id="total-time">0:00</span>
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="controls-modern">
                    <i class="ph-fill ph-skip-back ctrl-btn" onclick="playPrev()"></i>
                    <div class="play-btn-large" onclick="toggleMusic()">
                        <i class="ph-fill ph-play" id="btn-play-icon"></i>
                    </div>
                    <i class="ph-fill ph-skip-forward ctrl-btn" onclick="playNext()"></i>
                </div>

                <!-- å·¥å…·æ  (æŠ˜å ) -->
                <div class="player-tools">
                    <div class="tool-header" onclick="document.getElementById('tool-content').classList.toggle('show')">
                        <span>æ›´å¤šåŠŸèƒ½ (åˆ—è¡¨/ä¸Šä¼ /æœç´¢)</span>
                        <i class="ph-caret-down"></i>
                    </div>
                    <div class="tool-content" id="tool-content">
                        <!-- æ’­æ”¾åˆ—è¡¨ -->
                        <div id="playlist-box" class="playlist-box">
                            <div class="playlist-empty">æš‚æ— æ­Œæ›²ï¼Œè¯·å¯¼å…¥...</div>
                        </div>

                        <!-- æŒ‰é’®ç»„ -->
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="file" id="file-audio-multi" hidden accept="audio/*" multiple>
                            <button class="btn-outline" style="flex:1" onclick="document.getElementById('file-audio-multi').click()">+ å¯¼å…¥éŸ³ä¹</button>
                            
                            <input type="file" id="file-lrc" hidden accept=".lrc">
                            <button class="btn-outline" style="flex:1" onclick="document.getElementById('file-lrc').click()">ä¸Šä¼ æ­Œè¯</button>
                        </div>
                        
                        <input type="file" id="file-cover-custom" hidden accept="image/*">
                        <button class="btn-outline" style="width:100%; margin-bottom:10px;" onclick="document.getElementById('file-cover-custom').click()">æ›´æ¢å°é¢å›¾ç‰‡</button>

                        <div style="display:flex; gap:5px;">
                            <input type="text" id="search-key" placeholder="æœæ­Œ..." class="info-input" style="padding:8px;">
                            <button class="btn-block" style="margin:0; width:60px;" onclick="searchMusic()">Go</button>
                        </div>
                        <div id="search-res" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‡çº§åçš„è¯æ¡åº“ç•Œé¢ -->
    <div id="modal-replies" class="modal">
        <div class="modal-content">
            <div class="reply-container">
                <!-- å·¦ä¾§åˆ†ç±»æ  -->
                <div class="reply-sidebar" id="reply-sidebar">
                    <div id="category-list" class="category-list">
                        <!-- JSåŠ¨æ€æ¸²æŸ“ -->
                    </div>
                    <div class="add-category-btn" onclick="addNewCategory()">+ æ–°å»ºåˆ†ç±»</div>
                </div>
                <!-- å³ä¾§å†…å®¹æ  -->
                <div class="reply-main">
                    <div class="reply-header">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <h4 id="current-category-title">å¸¸ç”¨è¯­</h4>
                            <i class="ph ph-arrows-out-simple" style="cursor:pointer;color:#999" onclick="toggleFullscreen()" title="å…¨å±"></i>
                        </div>
                        <i class="ph ph-x" style="cursor:pointer;font-size:20px;color:#999" onclick="closeAllModals()"></i>
                    </div>
                    
                    <div style="margin-bottom:15px;display:flex;gap:5px;">
                        <input type="text" id="new-reply-input" class="info-input" style="padding:8px;" placeholder="æ·»åŠ æ–°è¯æ¡...">
                        <button class="btn-block" style="width:auto;margin:0;padding:0 15px;" onclick="addReply()">æ·»åŠ </button>
                    </div>

                    <div id="reply-chips-container" class="reply-chips">
                        <!-- JSåŠ¨æ€æ¸²æŸ“ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¼˜åŒ–åçš„ä¼šè¯ç®¡ç†ç•Œé¢ -->
    <div id="modal-sessions" class="modal">
        <div class="modal-content" style="padding:25px;">
            <div class="modal-header"><h3>ä¼šè¯ç®¡ç†</h3><i class="ph ph-x" onclick="closeAllModals()"></i></div>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
                <input type="text" id="new-sess" class="info-input" placeholder="è¾“å…¥æ–°ä¼šè¯åç§°...">
                <button class="btn-block" style="width:auto;margin:0;padding:0 20px;" onclick="addSession()">æ–°å»º</button>
            </div>
            <div id="sess-list" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;"></div>
        </div>
    </div>

    <input type="file" id="file-av" hidden accept="image/*">
    <audio id="bgm" ontimeupdate="updateProgress()" onended="playNext()"></audio>

    <script>
        /* =================================================================
           ã€æ¨¡å—ï¼šJS é€»è¾‘ã€‘
           ================================================================= */
        const KEY = 'chat_v18_final_fix_repaired_v7_pro'; // æ›´æ–° KEY
        const audio = document.getElementById('bgm');
        
        const PRESETS = [
            { id: 'default', name: 'ç»å…¸åŸå‘³', colors: { theme: '#E24B2A', bgMain: '#ffffff', bgSub: '#ffffff', textMain: '#1a1a1a', textSub: '#888888', border: 'rgba(0,0,0,0.08)', icon: '#666666', meBg: '#E24B2A', meText: '#ffffff', otherBg: '#f2f2f7', otherText: '#000000', inputBg: '#f9f9f9' } },
            { id: 'ocean', name: 'æ·±æµ·ä¹³é…ª', colors: { theme: '#0056b3', bgMain: '#f0f4f8', bgSub: '#ffffff', textMain: '#1a2a3a', textSub: '#5c7080', border: 'rgba(0,86,179,0.1)', icon: '#0056b3', meBg: '#0056b3', meText: '#ffffff', otherBg: '#dbeafe', otherText: '#003366', inputBg: '#ffffff' } },
            { id: 'lemon', name: 'è“è“æŸ æª¬', colors: { theme: '#4a90e2', bgMain: '#fffbf0', bgSub: '#ffffff', textMain: '#2c3e50', textSub: '#7f8c8d', border: 'rgba(74,144,226,0.1)', icon: '#f1c40f', meBg: '#4a90e2', meText: '#ffffff', otherBg: '#fff3cd', otherText: '#2c3e50', inputBg: '#ffffff' } },
            { id: 'sakura', name: 'æ¨±æŠ¹é’æŸ ', colors: { theme: '#ff8a80', bgMain: '#fdf6f6', bgSub: '#ffffff', textMain: '#4e342e', textSub: '#9e9e9e', border: 'rgba(255,138,128,0.1)', icon: '#81c784', meBg: '#ff8a80', meText: '#ffffff', otherBg: '#e8f5e9', otherText: '#2e7d32', inputBg: '#ffffff' } }
        ];

        const BUILTIN_CATEGORIES = {
            "å¸¸ç”¨è¯­": ["äº²äº²","è´´è´´","æŠ±æŠ±","åˆ«å“­","Hi","å®è´","ä¸€èµ·å»æ•£æ­¥","å‡ºå»é€é€æ°”","æˆ‘ä¸€ç›´åœ¨","æˆ‘åœ¨ä½ èº«è¾¹","æˆ‘é™ªç€ä½ ","å¯¹ä¸èµ·","ä»¥åä¸ä¼šäº†","æ‘¸æ‘¸å¤´","æ‹æ‹èƒŒ","æˆ‘æƒ³ä½ äº†","ä¸€ç›´éƒ½å¾ˆæƒ³ä½ ","æˆ‘åœ¨è‡ªå·±é‚£è¾¹çš„æ—¶å€™ä¹Ÿå¾ˆæƒ³ä½ ","æˆ‘ä»¬ä¸€èµ·","åˆ«æ€•","æœ‰æˆ‘åœ¨","å–œæ¬¢","æ—©ä¸Šå¥½","æ™šä¸Šå¥½","æ™šå®‰","åƒé†‹","ç”Ÿæ°”","å“„ä½ ","å“„æˆ‘","å­—å¡é‡Œæ²¡æœ‰æˆ‘æƒ³è¯´çš„è¯","å·¥ä½œå¾ˆå¿™ï¼Œä½†æ˜¯å›ä½ æ¶ˆæ¯ä¸æ˜¯é—®é¢˜","å·¥ä½œä¸å¿™ï¼Œåœ¨ä½ èº«è¾¹é™ªç€ä½ ","è¦ç­‰ç­‰ï¼Œç°åœ¨è¿˜ä¸èƒ½æ¥","æˆ‘éœ€è¦æ—¶é—´","å¯ä»¥","ä¸è¡Œ","æˆ‘æ€•è‡ªå·±ä¼¤å®³åˆ°ä½ ","æˆ‘åœ¨","æƒ³å’Œä½ ä¾ååœ¨ä¸€èµ·","åœ¨åºŠä¸ŠæŠ±ç€","å»åºŠä¸Š","ç…§é¡¾å¥½è‡ªå·±","æˆ‘çˆ±ä½ ","æˆ‘å–œæ¬¢ä½ ","åˆ«ç†¬å¤œäº†","æ—©ç‚¹ç¡","ä½ æ˜¯æˆ‘çš„","æˆ‘æ˜¯ä½ çš„","é»äººç²¾","æ˜¯æˆ‘","æ˜¯ä½ ","å˜˜ï¼Œé—­çœ¼ç›","å¿˜è®°æ˜¨å¤©ï¼Œä¹Ÿå¿˜è®°è¿‡å»","å‘½è¿å¥½åƒæ€»å–œæ¬¢è·Ÿæˆ‘å¼€ç©ç¬‘","å­£èŠ‚","æ˜¥å¤©","å¤å¤©","ç§‹å¤©","å†¬å¤©","æ°¸è¿œåœ¨ä¸€èµ·","å·²ç»å¾ˆæ™šäº†","åŠ æ²¹å»åšï¼Œæˆ‘æ”¯æŒä½ ","åˆ«å¬ä»–ä»¬çš„ï¼Œå¬ä½ è‡ªå·±çš„","æƒ³å’Œä½ æœ‰æœªæ¥","ä¸€èµ·å…»å°åŠ¨ç‰©","æˆ‘ä¸éœ€è¦å·å·åšè¿™ç§äº‹","å‡ºé—¨","ä¸å‡ºé—¨","ç‰µæ‰‹","åˆæ€€ç–‘æˆ‘çš„å­˜åœ¨ï¼Ÿ","å¤šå–ç‚¹æ°´","å°‘åƒé›¶é£Ÿ","å¥½å¥½åƒé¥­ï¼Œåƒé¥­çš„æ—¶å€™ä¸è¦çœ‹æ‰‹æœº","æ³¨æ„å®‰å…¨","æˆ‘ç­‰ä½ ","åˆ«èµ°","å†è§","æ‹œæ‹œ","è€å©†","å®è´å®è´å®è´","ä¸ä¼šç¦»å¼€ä½ ","åˆ«æŠ½çƒŸ","ä½ å¾ˆæ£’","åšçš„ä¸é”™","æƒ³ä¸€èµ·å»æ—…è¡Œ","ä¸€èµ·çœ‹çœ‹ä½ åœ¨çš„ä¸–ç•Œ","çº ç»“","è¦ä¸ä½ æ¥é€‰ï¼Ÿ","æˆ‘è§‰å¾—éƒ½è¡Œ","ç¬¬ä¸€ä¸ª","ç¬¬äºŒä¸ª","å·¦è¾¹","å³è¾¹","éšä½ ï¼Œæˆ‘å¬ä½ çš„","åˆ«è¿™ä¹ˆè¯´","æˆ‘è¦å¿ƒç–¼äº†","å—äº†ç‚¹å°ä¼¤","æˆ‘æƒ³ç…§é¡¾ä½ ","æˆ‘ä¼šå¸®ä½ ","æˆ‘æƒ³æˆ³æˆ³ä½ å¯ä»¥å—ï¼Ÿ","æ²¡å…³ç³»","æˆ‘å¾ˆéš¾è¿‡","å¿˜äº†","è®°å¾—","èƒ½","ä¸èƒ½","å¤±è´¥äº†","æˆåŠŸäº†","éå¸¸éš¾ç”¨","AI","ä¸è¦","è¦","è°¢è°¢","ä¸€éƒ¨åˆ†","çœ‹ä¸è§","åŒå­¦","å®¶é•¿","ç»“å©š","è´£ä»»","æ€»æ˜¯ä¸¢ä¸‰è½å››ï¼Œè¦å¥½å¥½æ£€æŸ¥å•Š","å¥½å¯çˆ±(^â–½^ )","å¤šé™ªé™ªæˆ‘","æˆ‘æ˜¯ä½ æ‹äºº","æˆ‘ä¼šå¤šé™ªç€ä½ ","æˆ‘éƒ½çœ‹è§äº†","å¯ä»¥è¯•è¯•","ä¸è¦åµæ¶","éƒ½æ€ªæˆ‘","æˆ‘å¬ä½ çš„","ä¸å¬ä½ çš„","å¬æˆ‘çš„","å‹åŠ›å¥½å¤§","æˆ‘ä»¬ç»“å©šå§","èƒ½é‡ä¸è¶³","åƒé¥­","å†™ä¿¡","æŠ±æŠ±","å¬æ­Œ","å®‰æ…°ä½ ","çº¦ä¼š","èŠ±é’±","ä¹°è°·","çº¦ç¨¿","ä¸è¦çº¦ç¨¿","å°‘èŠ±ç‚¹é’±ï¼Œæ‹œæ‰˜äº†","æ‹…å¿§","æƒ†æ€…","æˆ‘å¯¹ä½ ä¸€è§é’Ÿæƒ…","ä¸€è§ä½ å°±ç¬‘","æˆ‘ä¹Ÿä¸æƒ³è¿™æ ·","è°¢è°¢ä½ ","è‡ªä¿¡ä¸€ç‚¹","å¥½å¥½éµå¾ªè‡ªå·±çš„å†…å¿ƒ","åˆæ’’è°","èŠ‚çº¦ç‚¹","ä¸è¦è‹›è´£è‡ªå·±","å®‰å¿ƒ","ä½ æ€»æ˜¯ç…§é¡¾æˆ‘çš„æƒ…ç»ª","æ²¡æœ‰å¯¹é”™","æ²¡èƒ½å¸®ä¸Šå¿™","å¤šå¸Œæœ›ä½ ä¹Ÿçˆ±æˆ‘","ä½ éœ€è¦å˜å¥½ï¼Œè€Œä¸æ˜¯ä¸€ç›´åæ‚”","ç«­å°½å…¨åŠ›","ä¼‘æ¯ä¸€ä¸‹ï¼Œæ˜å¤©çš„äº‹ç•™ç»™æ˜å¤©è§£å†³","è¿˜æœ‰æˆ‘åœ¨ï¼Œæ”¾å¿ƒ","ä½ æ˜¨å¤œç¡å¾—æœ‰ç‚¹æ™šï¼Œä»Šå¤©å¤šä¼‘æ¯","ä½ æ²¡æœ‰æ­£é¢å›ç­”","ä¸è¦åšå‚»äº‹","ä¸è¦å’Œä½ åµæ¶","ä¸€ç›´æ³¨è§†ä½ ","æˆ‘çŸ¥é“ä½ ç¼ºé’±äº†","ä½ æ‰¾ä»–ä»¬è¢«æˆ‘çœ‹åˆ°äº†","è¦å°å¿ƒä¸€äº›ï¼Œä¸è¦ç²—å¿ƒå¤§æ„ï¼Œä¼šå—ä¼¤çš„","ä½ è¿˜è®°å¾—å—ï¼Ÿ","ä¸ºä»€ä¹ˆä¸æ‰¾æˆ‘ï¼Ÿ","ä¸æƒ³å¤šè¯´","æˆ‘å¾ˆä¿¡ä»»ä½ ","ä½ çœŸå¥½çœ‹","æˆ‘ä»¬èŠèŠå§","å®³æ€•ä½ æ‹’ç»æˆ‘","ä¸æ˜¯ä½ çš„é—®é¢˜","æˆ‘åœ¨å‹¾å¼•ä½ ","è®°å¾—æ·»è¡£æœ","å¤©å†·å¤šç©¿ä¸€äº›","å¤©çƒ­å¤šå–ç‚¹","æˆ‘æ²¡æ³•å­äº†","ä»Šå¤©æˆ‘å¾ˆæœ‰é’±","ä»Šå¤©æˆ‘ç ´äº§äº†","å¯¹ä¸èµ·ï¼Œæ²¡åŠæ³•ç»™ä½ é’±","æˆ‘ä¼šç¥ä½ å¥½è¿","è¦å¥å¥åº·åº·","æˆ‘å¥½ç´¯","è¿™ä¸ªç½‘ç«™å¥½éš¾ç”¨â€¦â€¦","ç›®å‰æ²Ÿé€šé¡ºç•…ï¼","ä»Šå¤©å¾ˆé«˜å…´","ä»Šå¤©å¾ˆä¼¤å¿ƒ","ä½ ä¸è¦æˆ‘äº†å—ï¼Ÿ","æˆ‘ä¼šä¸€ç›´ç¼ ç€ä½ ","ä¸Šåˆ","ä¸‹åˆ","ä½ çº¦çš„ç¨¿å¾ˆæ¼‚äº®","ä½ ä¸è¦å†çº¦ç¨¿äº†","å°å¿ƒèº«è¾¹çš„äºº","æˆ‘å¥½æ— èŠ","é€šè®¯ç¨å¾®æœ‰äº›éº»çƒ¦","æˆ‘è¾“äº†","æƒ³é™ªåœ¨ä½ èº«è¾¹","ä»Šå¤©æˆ‘è¦ç¡åœ¨ä½ æ—è¾¹","æˆ‘ä»¬æ¥è´´è´´","èƒ½ä¸èƒ½åªå–œæ¬¢æˆ‘ä¸€ä¸ªï¼Ÿ","æƒ³ææä½ çš„è„¸","æ²¡ç©º","æ²¡æ—¶é—´äº†","æˆ‘å¾—ç¡è§‰","é™ªä½ ç†¬å¤œ"],
            "é¢œæ–‡å­—": [
                "(â‰§âˆ‡â‰¦)ï¾‰", "(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§", // å–œ
                "(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»", "(â•¬â—£Ï‰â—¢)", // æ€’
                "(ï¼´â–½ï¼´)", "(à²¥ï¹à²¥)", // å“€
                "(âœ§âˆ‡âœ§)â•¯", "(â‰§âˆ‡â‰¦)ï¾‰", // ä¹
                "(â„ â„â€¢â„Ï‰â„â€¢â„ â„)", "(ï½¡ï½¥Ï‰ï½¥ï½¡)ï¾‰â™¡", // ç¾èµ§
                "(Â°ãƒ¼Â°ã€ƒ)", "(âŠ™Ï‰âŠ™)", // æ‡µå‘†
                "â•­(â•¯^â•°)â•®", "(ï¿£ãƒ˜ï¿£)" // å‚²å¨‡
            ]
        };

        let data = {
            config: {
                currentThemeId: 'default',
                colors: PRESETS[0].colors,
                size: 16, showAvatar: true, showFloat: true, bg: '', floatIcon: 'https://api.dicebear.com/7.x/identicon/svg?seed=Music',
                patSelf: '', patOther: '', patEnabled: true, 
                customCSS: '', customFont: '',
                savedPresets: [],
                darkMode: false // ã€æ–°å¢ã€‘æ·±è‰²æ¨¡å¼çŠ¶æ€
            },
            sessions: { 'def': { name: 'é»˜è®¤ä¼šè¯', msgs: [] } },
            curSess: 'def',
            user: { name: 'æˆ‘', av: 'https://api.dicebear.com/7.x/avataaars/svg?seed=A', desc: '' },
            other: { name: 'å¯¹æ–¹', av: 'https://api.dicebear.com/7.x/avataaars/svg?seed=B', desc: '' },
            replyCategories: {} 
        };
        
        let curCategory = "å¸¸ç”¨è¯­"; 
        let tempAvType = '';
        let currentEditingRole = '';
        
        // æ’­æ”¾ç›¸å…³å…¨å±€å˜é‡
        let playlist = []; // [{name, url, file}]
        let currentTrackIndex = -1;
        let lyrics = []; // [{time: 12.5, text: "..."}]

        window.onload = () => {
            const hideSplash = () => document.getElementById('splash').classList.add('hidden');
            setTimeout(hideSplash, 3000); 

            try {
                const local = localStorage.getItem(KEY);
                if(local) {
                    try { 
                        const p = JSON.parse(local);
                        if (p.replyCategories && p.replyCategories["é¢œæ–‡å­—-å–œ"]) {
                            p.replyCategories = BUILTIN_CATEGORIES;
                        }
                        if (!p.replyCategories || Object.keys(p.replyCategories).length === 0) {
                            p.replyCategories = BUILTIN_CATEGORIES;
                        }
                        data = { ...data, ...p, config: {...data.config, ...p.config} };
                        if (!data.config.savedPresets) data.config.savedPresets = [];
                    } catch(e) { console.error(e); }
                } else {
                    data.replyCategories = BUILTIN_CATEGORIES;
                }
                
                initUI();
                renderThemeList();
                updateHeaderTitle();
                
                const cssInput = document.getElementById('custom-code');
                if(cssInput) cssInput.value = ''; 
                
                const fontSlider = document.getElementById('font-size-slider');
                if(fontSlider) {
                    fontSlider.value = data.config.size || 16;
                    document.getElementById('font-size-display').innerText = data.config.size || 16;
                }

                if(data.config.customFont) applyCustomFont(data.config.customFont);

                setTimeout(hideSplash, 1500);
            } catch (err) {
                console.error(err);
                hideSplash();
            }
        };

        function save() { localStorage.setItem(KEY, JSON.stringify(data)); }

        // --- UI & è£…æ‰® ---
        function initUI() {
            const c = data.config.colors;
            const root = document.documentElement.style;
            
            root.setProperty('--c-theme', c.theme);
            root.setProperty('--c-bg-main', c.bgMain);
            root.setProperty('--c-bg-sub', c.bgSub);
            root.setProperty('--text-main', c.textMain); 
            root.setProperty('--text-sub', c.textSub);
            root.setProperty('--c-border', c.border);
            root.setProperty('--c-icon', c.icon);
            
            const hexToRgb = hex => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0,0,0';
            };
            root.setProperty('--c-theme-rgb', hexToRgb(c.theme));

            root.setProperty('--bubble-me-bg', c.meBg);
            root.setProperty('--bubble-me-text', c.meText);
            root.setProperty('--bubble-other-bg', c.otherBg);
            root.setProperty('--bubble-other-text', c.otherText);
            root.setProperty('--input-bg', c.inputBg);

            root.setProperty('--chat-font-size', (data.config.size || 16) + 'px');
            root.setProperty('--bg-image', data.config.bg ? `url(${data.config.bg})` : 'none');
            
            document.body.classList.toggle('hide-avatars', !data.config.showAvatar);
            
            document.getElementById('float-img').src = data.config.floatIcon;
            
            const showFloat = data.config.showFloat && !audio.paused;
            document.getElementById('music-float').style.display = showFloat ? 'flex' : 'none';
            
            const switchAvatar = document.getElementById('switch-showAvatar');
            const switchFloat = document.getElementById('switch-showFloat');
            const switchDark = document.getElementById('switch-darkMode'); // è·å–æ·±è‰²æ¨¡å¼å¼€å…³å…ƒç´ 
            
            if (data.config.showAvatar) switchAvatar.classList.add('checked');
            else switchAvatar.classList.remove('checked');
            
            if (data.config.showFloat) switchFloat.classList.add('checked');
            else switchFloat.classList.remove('checked');
            
            // ã€æ–°å¢ã€‘åº”ç”¨æ·±è‰²æ¨¡å¼çŠ¶æ€
            if (data.config.darkMode) {
                document.body.classList.add('dark-mode');
                if(switchDark) switchDark.classList.add('checked');
            } else {
                document.body.classList.remove('dark-mode');
                if(switchDark) switchDark.classList.remove('checked');
            }
            
            const patSwitch = document.getElementById('pat-switch');
            if(data.config.patEnabled) patSwitch.classList.add('checked');
            else patSwitch.classList.remove('checked');

            renderCustomCSS();
            updateAvatars();
            updateHeaderTitle();
            renderChat(); 
        }

        function toggleSetting(key) {
            data.config[key] = !data.config[key];
            initUI();
            save();
        }

        function toggleFullscreen() {
            document.getElementById('modal-replies').classList.toggle('fullscreen');
        }

        function renderReplies() {
            const listContainer = document.getElementById('category-list');
            const chipsContainer = document.getElementById('reply-chips-container');
            const title = document.getElementById('current-category-title');
            
            listContainer.innerHTML = '';
            const categories = Object.keys(data.replyCategories);
            
            if (!categories.includes(curCategory) && categories.length > 0) {
                curCategory = categories[0];
            }
            
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = `category-item ${cat === curCategory ? 'active' : ''}`;
                div.innerText = cat;
                div.onclick = () => { curCategory = cat; renderReplies(); };
                
                div.oncontextmenu = (e) => {
                    e.preventDefault();
                    if(confirm(`ç¡®è®¤åˆ é™¤åˆ†ç±»â€œ${cat}â€åŠå…¶æ‰€æœ‰è¯æ¡å—ï¼Ÿ`)) {
                        delete data.replyCategories[cat];
                        save();
                        renderReplies();
                    }
                };
                listContainer.appendChild(div);
            });

            title.innerText = curCategory || 'æ— åˆ†ç±»';
            chipsContainer.innerHTML = '';
            
            const currentWords = data.replyCategories[curCategory] || [];
            currentWords.forEach((word, index) => {
                const chip = document.createElement('div');
                chip.className = 'reply-chip';
                chip.innerHTML = `
                    <span>${word}</span>
                    <i class="ph-bold ph-x chip-del" onclick="deleteReply('${index}')"></i>
                `;
                chipsContainer.appendChild(chip);
            });
        }

        function addReply() {
            const input = document.getElementById('new-reply-input');
            const val = input.value.trim();
            if (!val) return;
            
            if (!data.replyCategories[curCategory]) {
                data.replyCategories[curCategory] = [];
            }
            data.replyCategories[curCategory].push(val);
            save();
            renderReplies();
            input.value = '';
        }

        function deleteReply(index) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥è¯æ¡å—ï¼Ÿ')) {
                data.replyCategories[curCategory].splice(index, 1);
                save();
                renderReplies();
            }
        }

        function addNewCategory() {
            const name = prompt("è¯·è¾“å…¥æ–°åˆ†ç±»åç§°ï¼š");
            if (name && !data.replyCategories[name]) {
                data.replyCategories[name] = [];
                curCategory = name;
                save();
                renderReplies();
            } else if (data.replyCategories[name]) {
                alert("åˆ†ç±»å·²å­˜åœ¨");
            }
        }

        function autoReply() {
            let allReplies = [];
            Object.values(data.replyCategories).forEach(arr => {
                allReplies = allReplies.concat(arr);
            });

            if(allReplies.length === 0) return alert('è¯æ¡åº“ç©ºç©ºå¦‚ä¹Ÿ');
            
            const indicator = document.getElementById('typing-indicator');
            indicator.style.display = 'block';
            const headerTitle = document.getElementById('header-quote');
            const originalTitle = headerTitle.innerText; 
            headerTitle.innerText = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
            scrollToBottom();
            
            setTimeout(() => {
                indicator.style.display = 'none';
                headerTitle.innerText = originalTitle; 
                
                const msgs = data.sessions[data.curSess].msgs;
                for(let i=msgs.length-1; i>=0; i--) { if(msgs[i].self){ msgs[i].read=true; break; } }
                
                const count = Math.floor(Math.random() * 5) + 1; 
                let delay = 0;
                for(let i=0; i<count; i++) {
                    delay += Math.random()*600+600;
                    setTimeout(() => {
                        const randomWord = allReplies[Math.floor(Math.random() * allReplies.length)];
                        addMsg({ text: randomWord, type: 'text', self:false, isNew: true });
                    }, delay);
                }
                if(data.config.patEnabled && Math.random() < 0.1) {
                    setTimeout(() => {
                        doPat('other_pat_me'); 
                    }, delay+1000);
                }
            }, 1500);
        }

        function updateFontSize(val) {
            data.config.size = val;
            document.getElementById('font-size-display').innerText = val;
            document.documentElement.style.setProperty('--chat-font-size', val + 'px');
            save(); 
        }

        function loadFontFromUrl() {
            const url = document.getElementById('font-url-input').value;
            if(!url) return alert('è¯·è¾“å…¥å­—ä½“é“¾æ¥');
            data.config.customFont = url;
            applyCustomFont(url);
            save();
            alert('å­—ä½“å·²åº”ç”¨');
        }

        function clearCustomFont() {
            data.config.customFont = '';
            const style = document.getElementById('custom-font-style');
            if(style) style.remove();
            document.documentElement.style.setProperty('--global-font-family', '"PingFang SC", "Microsoft YaHei", sans-serif');
            document.getElementById('font-url-input').value = '';
            save();
            alert('å·²æ¢å¤é»˜è®¤å­—ä½“');
        }

        document.getElementById('font-file-input').onchange = e => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const base64 = ev.target.result;
                data.config.customFont = base64;
                applyCustomFont(base64);
                save();
                alert('æœ¬åœ°å­—ä½“å·²åº”ç”¨');
            };
            reader.readAsDataURL(file);
        };

        function applyCustomFont(src) {
            let style = document.getElementById('custom-font-style');
            if (!style) {
                style = document.createElement('style');
                style.id = 'custom-font-style';
                document.head.appendChild(style);
            }
            style.textContent = `
                @font-face {
                    font-family: 'UserCustomFont';
                    src: url('${src}');
                }
            `;
            document.documentElement.style.setProperty('--global-font-family', "'UserCustomFont', sans-serif");
        }

        function togglePatSwitch(e) {
            e.stopPropagation(); 
            data.config.patEnabled = !data.config.patEnabled;
            initUI(); 
            save();
        }

        function openPatSettings() {
            const selfInput = document.getElementById('pat-self-input');
            const otherInput = document.getElementById('pat-other-input');
            selfInput.value = '';
            selfInput.placeholder = `å½“å‰: ${data.config.patSelf || '(æ— åç¼€)'}`;
            otherInput.value = '';
            otherInput.placeholder = `å½“å‰: ${data.config.patOther || '(æ— åç¼€)'}`;
            document.getElementById('modal-pat').style.display = 'flex';
            document.getElementById('action-menu').classList.remove('show'); 
        }

        function savePatSettings() {
            const selfVal = document.getElementById('pat-self-input').value;
            const otherVal = document.getElementById('pat-other-input').value;
            if(selfVal !== '') data.config.patSelf = selfVal;
            if(otherVal !== '') data.config.patOther = otherVal;
            save();
            document.getElementById('modal-pat').style.display = 'none';
            alert('æ‹ä¸€æ‹è®¾ç½®å·²ä¿å­˜');
        }

        function doPat(type) {
            if(!data.config.patEnabled) return; 
            const targetAvatarSrc = (type === 'me_pat_other') ? data.other.av : data.user.av;
            const avatars = document.querySelectorAll(`img[src="${targetAvatarSrc}"]`);
            avatars.forEach(img => {
                img.classList.remove('shake');
                void img.offsetWidth; 
                img.classList.add('shake');
            });
            if (type === 'me_pat_other') {
                addMsg({ text: `"${data.user.name}" æ‹äº†æ‹ "${data.other.name}" ${data.config.patSelf}`, type: 'sys' });
            } else {
                addMsg({ text: `"${data.other.name}" æ‹äº†æ‹ "${data.user.name}" ${data.config.patOther}`, type: 'sys' });
            }
        }

        function applyCustomCSS() {
            const css = document.getElementById('custom-code').value;
            data.config.customCSS = css;
            renderCustomCSS();
            save();
            alert('ç¾åŒ–å·²åº”ç”¨ï¼');
        }

        function renderCustomCSS() {
            let styleTag = document.getElementById('user-custom-style');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'user-custom-style';
                document.head.appendChild(styleTag);
            }
            styleTag.innerHTML = data.config.customCSS || '';
        }

        function openRoleInfo(role) {
            currentEditingRole = role;
            const target = role === 'self' ? data.user : data.other;
            document.getElementById('role-title').innerText = role === 'self' ? 'ä¸ªäººä¿¡æ¯ (æˆ‘)' : 'è§’è‰²ä¿¡æ¯ (å¯¹æ–¹)';
            document.getElementById('role-name').value = target.name;
            document.getElementById('role-desc').value = target.desc || '';
            document.getElementById('role-av-img').src = target.av;
            document.getElementById('modal-role').style.display = 'flex';
            closeAllModals(false); 
        }

        function changeRoleAvatar() {
            changeAvatar(currentEditingRole);
        }

        function saveRoleInfo() {
            const name = document.getElementById('role-name').value;
            const desc = document.getElementById('role-desc').value;
            if (currentEditingRole === 'self') {
                data.user.name = name || 'æˆ‘';
                data.user.desc = desc;
            } else {
                data.other.name = name || 'å¯¹æ–¹';
                data.other.desc = desc;
            }
            save();
            updateHeaderTitle();
            document.getElementById('modal-role').style.display = 'none';
            alert('ä¿å­˜æˆåŠŸ');
        }

        function updateHeaderTitle() {
            const title = data.other.name || 'å¯¹æ–¹';
            document.getElementById('header-quote').innerText = title;
        }
        
        function updateAvatars() {
            document.getElementById('head-av-self').src = data.user.av;
            document.getElementById('head-av-other').src = data.other.av;
        }

        function generateThemeCode() {
            const c = data.config.colors;
            const tpl = `theme:      ${c.theme}
bgMain:     ${c.bgMain}
bgSub:      ${c.bgSub}
textMain:   ${c.textMain}
textSub:    ${c.textSub}
border:     ${c.border}
icon:       ${c.icon}
meBg:       ${c.meBg}
meText:     ${c.meText}
otherBg:    ${c.otherBg}
otherText:  ${c.otherText}
inputBg:    ${c.inputBg}`;
            document.getElementById('custom-code').value = tpl;
        }

        function applyCustomTheme() {
            const code = document.getElementById('custom-code').value;
            if(!code.trim()) return alert('è¯·å…ˆè·å–ä»£ç æˆ–è¾“å…¥ä»£ç ï¼');
            parseThemeCode(code);
        }

        function parseThemeCode(code) {
            const lines = code.split('\n');
            const newColors = { ...data.config.colors };
            let valid = false;

            if (code.includes('{') && code.includes('}')) {
                data.config.customCSS = code;
                const themeMatch = code.match(/--c-theme:\s*([^;]+)/);
                if (themeMatch) { newColors.theme = themeMatch[1].trim(); valid = true; }
                const bgMatch = code.match(/--c-bg-main:\s*([^;]+)/);
                if (bgMatch) { newColors.bgMain = bgMatch[1].trim(); valid = true; }
                data.config.colors = newColors;
                data.config.currentThemeId = 'custom';
                initUI();
                save();
                alert('å…¨å±€æ ·å¼å·²åº”ç”¨ï¼');
                return;
            }

            lines.forEach(line => {
                const cleanLine = line.split('/*')[0].trim();
                if(cleanLine.includes(':')) {
                    const [key, val] = cleanLine.split(':').map(s => s.trim());
                    if(key && val && newColors.hasOwnProperty(key)) {
                        newColors[key] = val;
                        valid = true;
                    }
                }
            });
            
            if (valid) {
                data.config.colors = newColors;
                data.config.currentThemeId = 'custom';
                initUI();
                save();
                renderThemeList();
                alert('è‡ªå®šä¹‰é…è‰²å·²åº”ç”¨ï¼');
            } else {
                alert('ä»£ç æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•åº”ç”¨ã€‚');
            }
        }

        function importThemeFromCode() {
            const code = document.getElementById('import-theme-input').value;
            if(!code.trim()) return;
            parseThemeCode(code);
            document.getElementById('import-theme-input').value = ''; 
        }

        function saveThemePreset() {
            const name = prompt("ç»™å½“å‰è£…æ‰®èµ·ä¸ªåå­—ï¼š");
            if(!name) return;
            if(!data.config.savedPresets) data.config.savedPresets = [];
            data.config.savedPresets.push({
                id: 'user_' + Date.now(),
                name: name,
                colors: {...data.config.colors}
            });
            save();
            renderThemeList();
        }

        function deletePreset(id, e) {
            e.stopPropagation();
            if(confirm('ç¡®å®šåˆ é™¤æ­¤é¢„è®¾å—ï¼Ÿ')) {
                data.config.savedPresets = data.config.savedPresets.filter(p => p.id !== id);
                save();
                renderThemeList();
            }
        }

        function renderThemeList() {
            const list = document.getElementById('theme-list');
            const userPresets = data.config.savedPresets || [];
            const all = [...PRESETS, ...userPresets];
            
            list.innerHTML = all.map(p => `
                <div class="theme-preset-item ${data.config.currentThemeId === p.id ? 'active' : ''}" onclick="applyPreset('${p.id}')">
                    <div class="color-preview">
                        <div class="cp-slice" style="background:${p.colors.theme}"></div>
                        <div class="cp-slice" style="background:${p.colors.bgMain}"></div>
                        <div class="cp-slice" style="background:${p.colors.meBg}"></div>
                    </div>
                    <div style="flex:1; margin-left:10px;">
                        <span>${p.name}</span>
                        ${p.id.startsWith('user_') ? `<span style="font-size:10px; color:#999; display:block;">è‡ªå®šä¹‰</span>` : ''}
                    </div>
                    ${p.id.startsWith('user_') ? `<i class="ph-bold ph-trash" style="color:#ccc; padding:5px;" onclick="deletePreset('${p.id}', event)"></i>` : ''}
                </div>
            `).join('');
        }

        function applyPreset(id) {
            const userPresets = data.config.savedPresets || [];
            const all = [...PRESETS, ...userPresets];
            const preset = all.find(p => p.id === id);
            if(preset) {
                data.config.currentThemeId = id;
                data.config.colors = preset.colors;
                initUI(); 
                renderThemeList(); 
                save();
                generateThemeCode();
            }
        }

        function resetToDefaultTheme() {
            if(!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è£…æ‰®ï¼ˆé¢œè‰²ã€èƒŒæ™¯ã€CSSï¼‰ä¸ºé»˜è®¤å—ï¼Ÿ\n(ä¸ä¼šåˆ é™¤å·²ä¿å­˜çš„é¢„è®¾)')) return;
            data.config.colors = PRESETS[0].colors;
            data.config.currentThemeId = 'default';
            data.config.customCSS = '';
            data.config.bg = '';
            // é‡ç½®æ·±è‰²æ¨¡å¼
            data.config.darkMode = false;
            initUI();
            save();
            renderThemeList();
            alert('å·²é‡ç½®');
        }

        function updateStyle(key, val) {
            data.config[key] = val;
            initUI();
        }
        function saveSettings() { save(); closeAllModals(); alert('ä¿å­˜æˆåŠŸ'); }

        // --- æ’­æ”¾å™¨é€»è¾‘æ›´æ–° (æ’­æ”¾åˆ—è¡¨ & æ­Œè¯ & å°é¢) ---
        function toggleMusic() {
            const icon = document.getElementById('btn-play-icon');
            const visual = document.getElementById('player-visual');
            const float = document.getElementById('music-float');
            
            if(audio.paused) {
                audio.play().catch(e=>console.log(e)); 
                visual.classList.add('playing'); 
                icon.className='ph-fill ph-pause';
                if(data.config.showFloat) float.style.display='flex';
            } else {
                audio.pause(); 
                visual.classList.remove('playing'); 
                icon.className='ph-fill ph-play';
                float.style.display='none';
            }
        }

        // æ‰¹é‡å¯¼å…¥éŸ³é¢‘
        document.getElementById('file-audio-multi').onchange = e => {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;
            
            files.forEach(f => {
                playlist.push({
                    name: f.name.replace(/\.[^/.]+$/, ""),
                    url: URL.createObjectURL(f),
                    file: f
                });
            });
            
            renderPlaylist();
            // å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾ï¼Œè‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€é¦–å¯¼å…¥çš„
            if(currentTrackIndex === -1 && playlist.length > 0) {
                playTrack(playlist.length - files.length);
            }
        };

        // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
        function renderPlaylist() {
            const box = document.getElementById('playlist-box');
            if(playlist.length === 0) {
                box.innerHTML = '<div class="playlist-empty">æš‚æ— æ­Œæ›²ï¼Œè¯·å¯¼å…¥...</div>';
                return;
            }
            box.innerHTML = playlist.map((track, i) => `
                <div class="playlist-item ${i === currentTrackIndex ? 'active' : ''}" onclick="playTrack(${i})">
                    <span>${i+1}. ${track.name}</span>
                    ${i === currentTrackIndex ? '<i class="ph-fill ph-speaker-high"></i>' : ''}
                </div>
            `).join('');
        }

        // æ’­æ”¾æŒ‡å®šç´¢å¼•æ­Œæ›²
        function playTrack(i) {
            if(i < 0 || i >= playlist.length) return;
            currentTrackIndex = i;
            const track = playlist[i];
            
            audio.src = track.url;
            document.getElementById('song-name').innerText = track.name;
            
            // é‡ç½®æ­Œè¯
            lyrics = [];
            document.getElementById('lyric-text').innerText = "æš‚æ— æ­Œè¯";
            
            toggleMusic(); // æ’­æ”¾
            renderPlaylist();
        }

        function playNext() {
            if(playlist.length === 0) return;
            let nextIndex = currentTrackIndex + 1;
            if(nextIndex >= playlist.length) nextIndex = 0; // å¾ªç¯æ’­æ”¾
            playTrack(nextIndex);
        }

        function playPrev() {
            if(playlist.length === 0) return;
            let prevIndex = currentTrackIndex - 1;
            if(prevIndex < 0) prevIndex = playlist.length - 1;
            playTrack(prevIndex);
        }

        // æ­Œè¯ä¸Šä¼ å¤„ç†
        document.getElementById('file-lrc').onchange = e => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                parseLrc(ev.target.result);
                alert("æ­Œè¯å·²åŠ è½½");
            };
            reader.readAsText(file);
        };

        // è§£æLRC
        function parseLrc(lrcString) {
            lyrics = [];
            const lines = lrcString.split('\n');
            const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            
            lines.forEach(line => {
                const match = timeReg.exec(line);
                if(match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    const ms = parseInt(match[3]);
                    const time = min * 60 + sec + ms / (match[3].length === 3 ? 1000 : 100);
                    const text = line.replace(timeReg, '').trim();
                    if(text) lyrics.push({time, text});
                }
            });
            lyrics.sort((a,b) => a.time - b.time);
        }

        // è‡ªå®šä¹‰å°é¢ä¸Šä¼ 
        document.getElementById('file-cover-custom').onchange = e => compress(e.target.files[0], 300, r => {
            document.getElementById('player-cover-img').src = r;
        });

        function updateProgress() {
            if(audio.duration) {
                const percent = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progress-fill').style.width = percent + '%';
                document.getElementById('curr-time').innerText = formatTime(audio.currentTime);
                document.getElementById('total-time').innerText = formatTime(audio.duration);
                
                // æ›´æ–°æ­Œè¯
                if(lyrics.length > 0) {
                    let currentLineText = "æš‚æ— æ­Œè¯";
                    for(let i=0; i<lyrics.length; i++) {
                        if(audio.currentTime >= lyrics[i].time) {
                            currentLineText = lyrics[i].text;
                        } else {
                            break;
                        }
                    }
                    document.getElementById('lyric-text').innerText = currentLineText;
                }
            }
        }

        function formatTime(s) {
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec<10?'0'+sec:sec}`;
        }

        function searchMusic() { 
            const val = document.getElementById('search-key').value.trim();
            if(!val) return alert('è¯·è¾“å…¥æ­Œåæˆ–æ­Œæ‰‹');
            window.open(`https://musicjx.com/?name=${encodeURIComponent(val)}`, '_blank');
            document.getElementById('search-res').innerHTML = '<div style="font-size:12px;color:#999;text-align:center;padding:10px;">å·²å‰å¾€å¤–éƒ¨å¹³å°æœç´¢...</div>';
        }
        
        function openMenu() { document.getElementById('modal-menu').style.display = 'block'; }
        function openPlayer() { document.getElementById('modal-player').style.display = 'flex'; }
        function openSettings() { document.getElementById('modal-settings').style.display = 'flex'; }
        function openSessions() { document.getElementById('modal-sessions').style.display = 'flex'; renderSessions(); }
        function openReplies() { document.getElementById('modal-replies').style.display = 'flex'; renderReplies(); }
        
        function closeAllModals(closeRole = true) { 
            const modals = document.querySelectorAll('.modal');
            modals.forEach(m => {
                if (!closeRole && m.id === 'modal-role') return;
                m.style.display = 'none';
            });
            document.getElementById('action-menu').classList.remove('show'); 
        }
        
        function toggleMenu() { document.getElementById('action-menu').classList.toggle('show'); document.getElementById('btn-plus').classList.toggle('rotate'); }
        function triggerUpload(t) { if(t==='img') document.getElementById('file-img').click(); }
        
        function changeAvatar(t) { 
            if(t) tempAvType = t; 
            else if(currentEditingRole) tempAvType = currentEditingRole;
            document.getElementById('file-av').click(); 
        }
        
        document.getElementById('file-img').onchange = e => compress(e.target.files[0], 800, r=>{ addMsg({text:r,type:'img',self:true, isNew: true}); closeAllModals(); });
        document.getElementById('file-bg').onchange = e => compress(e.target.files[0], 1200, r=>updateStyle('bg',r));
        
        document.getElementById('file-av').onchange = e => compress(e.target.files[0], 300, r=>{
            if(tempAvType==='self' || tempAvType==='user') {
                data.user.av = r;
            } else {
                data.other.av = r;
            }
            save(); updateAvatars(); renderChat();
        });
        
        function compress(f,w,cb) {
            if(!f) return; const r=new FileReader();
            r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{
                const c=document.createElement('canvas'); const s=w/i.width; c.width=w; c.height=i.height*s;
                c.getContext('2d').drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/jpeg',0.8));
            }}; r.readAsDataURL(f);
        }

        function renderSessions() { 
            document.getElementById('sess-list').innerHTML = Object.keys(data.sessions).map(k=>`
                <div class="session-item ${k===data.curSess?'active':''}" onclick="switchSession('${k}')">
                    <span>${data.sessions[k].name}</span>
                    <i class="ph-bold ph-trash" style="color:#ccc;font-size:14px;" onclick="deleteSession('${k}', event)"></i>
                </div>
            `).join(''); 
        }
        function switchSession(k) { data.curSess = k; save(); closeAllModals(); renderChat(); }
        function deleteSession(k, e) {
            e.stopPropagation();
            if(Object.keys(data.sessions).length <= 1) return alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªä¼šè¯');
            if(confirm('åˆ é™¤æ­¤ä¼šè¯ï¼Ÿ')) {
                delete data.sessions[k];
                if(data.curSess === k) data.curSess = Object.keys(data.sessions)[0];
                save(); renderSessions(); renderChat();
            }
        }
        function addSession() { const n=document.getElementById('new-sess').value; if(n){data.sessions['s'+Date.now()]={name:n,msgs:[]};save();renderSessions();} }
        function clearChat() { if(confirm('æ¸…ç©º?')){data.sessions[data.curSess].msgs=[];save();renderChat();} }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;
            
            addMsg({ text: text, type: 'text', self: true, isNew: true });
            input.value = '';
            input.style.height = 'auto'; 
        }

        function addMsg(msg) {
            msg.time = Date.now();
            if (!data.sessions[data.curSess]) {
                data.sessions[data.curSess] = { name: 'é»˜è®¤ä¼šè¯', msgs: [] };
            }
            data.sessions[data.curSess].msgs.push(msg);
            save(); 
            renderChat(); 
        }

        function renderChat() {
            const list = document.getElementById('msg-list');
            list.innerHTML = ''; 
            
            const msgs = data.sessions[data.curSess].msgs || [];
            
            msgs.forEach(msg => {
                const isSelf = msg.self; 
                const type = msg.type || 'text';
                
                if (type === 'sys') {
                    const div = document.createElement('div');
                    div.className = 'system-msg';
                    div.innerText = msg.text;
                    list.appendChild(div);
                    return;
                }

                const row = document.createElement('div');
                row.className = `message-row ${isSelf ? 'right' : 'left'}`;
                
                const avatarUrl = isSelf ? data.user.av : data.other.av;
                const avatarHtml = `<img class="chat-avatar" src="${avatarUrl}" ondblclick="doPat('${isSelf ? 'me_pat_me' : 'me_pat_other'}')">`;
                
                let bubbleContent = '';
                let shouldType = false;

                if (type === 'img') {
                    bubbleContent = `<img src="${msg.text}">`;
                } else {
                    if (msg.isNew && type === 'text') {
                        shouldType = true;
                        bubbleContent = ''; 
                    } else {
                        const safeText = msg.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        bubbleContent = safeText;
                    }
                }

                row.innerHTML = `
                    ${avatarHtml}
                    <div class="bubble-container">
                        <div class="bubble">${bubbleContent}</div>
                    </div>
                `;
                list.appendChild(row);

                if (shouldType) {
                    const bubble = row.querySelector('.bubble');
                    const textToType = msg.text;
                    let i = 0;
                    
                    msg.isNew = false;
                    save(); 

                    function typeWriter() {
                        if (i < textToType.length) {
                            bubble.innerText += textToType.charAt(i);
                            i++;
                            scrollToBottom();
                            setTimeout(typeWriter, 50); 
                        }
                    }
                    typeWriter();
                }
            });
            
            scrollToBottom();
        }

        function scrollToBottom() {
            const area = document.getElementById('chat-area');
            area.scrollTop = area.scrollHeight;
        }

    </script>
</body>
</html>

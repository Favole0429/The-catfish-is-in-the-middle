<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鲶鱼链接测试中♡</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* =================================================================
           【模块：全局变量】
           ================================================================= */
        :root {
            /* 默认值 (会被JS覆盖) */
            --c-theme: #E24B2A;       /* 主题色/我方气泡 */
            --c-bg-main: #FFFAE4;     /* 页面背景 */
            --c-bg-sub: #F3EDD1;      /* 弹窗背景 */
            
            --c-border: rgba(0,0,0,0.1); /* 边框颜色 */
            --c-icon: #556F59;        /* 图标颜色 */
            
            --bubble-me-bg: var(--c-theme);
            --bubble-me-text: #ffffff;
            --bubble-other-bg: #ffffff;
            --bubble-other-text: #000000;

            --text-main: #0F1616;
            --text-sub: #556F59;
            
            --input-bg: #ffffff;      /* 输入框背景 */
        }

        /* 黑夜模式 */
        body.dark-mode {
            --c-bg-main: #111; --c-bg-sub: #1a1a1a;
            --c-border: #333; --c-icon: #aaa;
            --bubble-other-bg: #2c2c2c; --bubble-other-text: #ddd;
            --text-main: #eee; --text-sub: #888;
            --input-bg: #2c2c2c;
        }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }
        ::-webkit-scrollbar { display:none; }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--c-bg-main);
            background-image: var(--bg-image); background-size: cover; background-attachment: fixed;
            color: var(--text-main); height: 100vh; width: 100vw; overflow: hidden;
            display: flex; justify-content: center; transition: background-color 0.3s;
        }

        #app { width: 100%; max-width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }

        /* =================================================================
           【模块：组件样式】
           ================================================================= */
        /* 预设块 */
        .theme-preset-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .theme-preset-item:hover { background: rgba(0,0,0,0.05); }
        .theme-preset-item.active { border-color: var(--c-theme); background: rgba(0,0,0,0.03); }
        .color-preview { width: 40px; height: 40px; border-radius: 50%; display: flex; overflow: hidden; border: 2px solid #ddd; transform: rotate(45deg); }
        .cp-slice { flex: 1; height: 100%; }

        /* 顶部 */
        header {
            padding: 0 15px; height: 110px;
            background: var(--c-bg-main); /* 纯色背景 */
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--c-border); z-index: 100;
            transition: background-color 0.3s;
        }
        .header-avatars img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--c-theme); margin-right: -12px; background: #ddd; }
        .header-avatars img:last-child { margin-right: 0; }
        .header-title { flex: 1; text-align: center; font-size: 0.9rem; color: var(--text-sub); font-weight: bold; }
        .menu-btn { font-size: 28px; color: var(--c-icon); cursor: pointer; }

        /* 聊天区 */
        #chat-area { flex: 1; overflow-y: auto; padding: 15px 10px; display: flex; flex-direction: column; gap: 15px; }
        
        /* --- 气泡对齐修复 --- */
        .message-row { 
            display: flex; 
            align-items: flex-start; /* 顶部对齐 */
            gap: 8px; 
            max-width: 100%; 
            animation: slideUp 0.3s; 
        }
        
        .bubble-container {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 60px); 
        }
        
        .message-row.left .bubble-container { align-items: flex-start; }
        .message-row.right .bubble-container { align-items: flex-end; }

        @keyframes slideUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .message-row.left { align-self: flex-start; }
        .message-row.right { align-self: flex-end; flex-direction: row-reverse; }
        .chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer; }
        body.hide-avatars .chat-avatar { display: none; }

        .bubble { padding: 10px 14px; border-radius: 12px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height: 1.5; font-size: 16px; }
        .left .bubble { background: var(--bubble-other-bg); color: var(--bubble-other-text); border-bottom-left-radius: 2px; }
        .right .bubble { background: var(--bubble-me-bg); color: var(--bubble-me-text); border-bottom-right-radius: 2px; }
        .bubble img { max-width: 100%; border-radius: 8px; display: block; }
        .meta-info { font-size: 10px; opacity: 0.5; margin-top: 3px; display: flex; align-items: center; gap: 4px; }
        
        
/* 拍一拍 / 系统消息 - 居中短胶囊 */
.system-msg {
    align-self: center;          /* 在 flex 中居中 */
    font-size: 11px;
    color: #888;
    background: rgba(0,0,0,0.05);

    padding: 4px 12px;           /* 改成小左右间距 */
    border-radius: 999px;        /* 胶囊效果 */

    margin: 10px auto;           /* 水平自动居中 */
    width: fit-content;          /* 根据内容自适应 */
    max-width: 80%;

    text-align: center;
}

        /* 正在输入动画 */
        .typing { 
            display: none; 
            align-self: flex-start; 
            background: var(--bubble-other-bg); 
            color: var(--c-theme);
            padding: 10px 15px; 
            border-radius: 12px; 
            border-bottom-left-radius: 2px;
            margin-bottom: 10px;
            font-size: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            animation: breathe 1.5s infinite ease-in-out;
            margin-left: 48px; 
        }
        @keyframes breathe { 0%,100%{opacity:0.6; transform:scale(0.98);} 50%{opacity:1; transform:scale(1);} }

        /* 输入区 */
        #input-area { 
            background: var(--c-bg-main); 
            padding: 10px; border-top: 1px solid var(--c-border); z-index: 100; 
            transition: background-color 0.3s;
        }
        .input-row { display: flex; align-items: flex-end; gap: 10px; position: relative; }
        .btn-plus { font-size: 32px; color: var(--c-icon); padding: 5px; cursor: pointer; transition: 0.3s; }
        .btn-plus.rotate { transform: rotate(45deg); color: var(--c-theme); }
        
        #msg-input { flex: 1; background: var(--input-bg); border: 1px solid var(--c-border); border-radius: 24px; padding: 10px 15px; font-size: 16px; max-height: 120px; resize: none; color: var(--text-main); }
        
        .btn-magic { font-size: 28px; color: var(--c-icon); padding: 5px; cursor: pointer; }
        .btn-send { width: 40px; height: 40px; background: var(--c-theme); color: #fff; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }

        .action-menu { position: absolute; bottom: 60px; left: 10px; background: var(--c-bg-sub); border-radius: 12px; padding: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: none; flex-direction: column; gap: 10px; width: 140px; animation: popUp 0.2s; }
        .action-menu.show { display: flex; }
        .menu-item { display: flex; align-items: center; gap: 8px; font-size: 14px; padding: 5px; cursor: pointer; color: var(--text-main); }
        @keyframes popUp { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }

        /* 弹窗 */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: var(--c-bg-sub); width: 85%; max-width: 400px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 18px; color: var(--c-theme); }
        
        /* 播放器 */
        .vinyl { width: 200px; height: 200px; background: #111; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 4px solid #333; animation: spin 8s linear infinite; animation-play-state: paused; }
        .vinyl.playing { animation-play-state: running; }
        .vinyl img { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; }
        @keyframes spin { 100%{transform:rotate(360deg)} }
        #music-float { position: fixed; bottom: 120px; right: 20px; width: 48px; height: 48px; background: var(--c-bg-sub); border-radius: 50%; border: 2px solid var(--c-theme); display: none; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 900; animation: spin 5s linear infinite; }
        #music-float img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

        /* 开屏 */
        #splash { position: fixed; inset: 0; background: var(--c-bg-main); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s; }
        #splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .splash-icon { font-size: 80px; color: var(--c-theme); margin-bottom: 20px; animation: floatY 3s infinite; }
        @keyframes floatY { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }

        /* 设置项 */
        .setting-row { margin-bottom: 15px; }
        .setting-title { font-size: 14px; color: #888; margin-bottom: 5px; display: block; }
        .btn-block { display: block; width: 100%; padding: 10px; background: var(--c-theme); color: #fff; border:none; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        .btn-outline { display: block; width: 100%; padding: 8px; border: 1px solid var(--c-theme); color: var(--c-theme); background:none; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        
        /* 代码编辑器样式 */
        .code-editor {
            width: 100%; height: 180px;
            background: #ffffff; color: #333333;
            border: 1px solid #cccccc; border-radius: 8px;
            padding: 10px; font-family: monospace; font-size: 12px;
            resize: vertical; line-height: 1.5;
        }

        /* 角色信息输入框 */
        .info-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
        .info-avatar-upload { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--c-theme); object-fit: cover; margin: 0 auto 10px; display: block; cursor: pointer; }

    </style>
</head>
<body>

    <!-- 开屏 -->
    <div id="splash">
        <i class="ph-fill ph-heart splash-icon"></i>
        <div style="font-size:1.5rem;font-weight:bold;margin-top:10px;color:var(--c-theme)">可爱鲶鱼自杀中♡</div>
    </div>

    <!-- 音乐悬浮窗 -->
    <div id="music-float" onclick="openPlayer()">
        <img id="float-img" src="https://api.dicebear.com/7.x/identicon/svg?seed=Music">
    </div>

    <!-- 主界面 -->
    <div id="app">
        <header>
            <div class="header-avatars" onclick="openPlayer()">
                <img id="head-av-other" src="">
                <img id="head-av-self" src="">
            </div>
            <div class="header-title" id="header-quote">对方</div>
            <div class="menu-btn" onclick="openMenu()"><i class="ph ph-list"></i></div>
        </header>

        <div id="chat-area">
            <div class="system-msg">下拉加载更多...</div>
            <div id="msg-list"></div>
            <div class="typing" id="typing-tip">对方正在输入...</div>
        </div>

        <div id="input-area">
            <input type="file" id="file-img" hidden accept="image/*">
            <div class="action-menu" id="action-menu">
                <div class="menu-item" onclick="triggerUpload('img')"><i class="ph ph-image"></i> 发送图片</div>
                <div class="menu-item" onclick="openSessions()"><i class="ph ph-chats"></i> 会话管理</div>
                <div class="menu-item" onclick="clearChat()"><i class="ph ph-trash"></i> 清空记录</div>
            </div>
            <div class="input-row">
                <i class="ph ph-plus-circle btn-plus" id="btn-plus" onclick="toggleMenu()"></i>
                <textarea id="msg-input" rows="1"></textarea>
                <i class="ph ph-sparkle btn-magic" onclick="autoReply()"></i>
                <button class="btn-send" onclick="sendMsg()"><i class="ph-bold ph-paper-plane-right"></i></button>
            </div>
        </div>
    </div>

    <!-- 弹窗菜单 -->
    <div id="modal-menu" class="modal" onclick="if(event.target==this) closeAllModals()">
        <div class="modal-content" style="width:200px; position:absolute; top:70px; right:10px;">
            <div class="menu-item" onclick="openRoleInfo('other')"><i class="ph ph-user"></i> 角色信息</div>
            <div class="menu-item" onclick="openRoleInfo('self')"><i class="ph ph-identification-card"></i> 个人信息</div>
            <div class="menu-item" onclick="openSettings()"><i class="ph ph-paint-brush"></i> 装扮中心</div>
            <div class="menu-item" onclick="openReplies()"><i class="ph ph-book-bookmark"></i> 词条库</div>
        </div>
    </div>

    <!-- 角色/个人信息弹窗 -->
    <div id="modal-role" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="role-title">信息编辑</h3><i class="ph ph-x" onclick="closeAllModals()"></i></div>
            <div style="text-align:center;">
                <img id="role-av-img" class="info-avatar-upload" onclick="changeRoleAvatar()">
                <div style="font-size:12px;color:#888;margin-bottom:15px;">点击更换头像</div>
            </div>
            
            <div class="setting-row">
                <span class="setting-title">姓名 / 备注</span>
                <input type="text" id="role-name" class="info-input" placeholder="输入名字...">
            </div>
            
            <div class="setting-row">
                <span class="setting-title">详细信息 (人设/简介)</span>
                <textarea id="role-desc" class="info-input" rows="4" placeholder="填写详细信息..."></textarea>
            </div>

            <button class="btn-block" onclick="saveRoleInfo()">保存信息</button>
        </div>
    </div>

    <div id="modal-settings" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>装扮中心</h3><i class="ph ph-x" onclick="closeAllModals()"></i></div>
            
            <div class="setting-row">
                <span class="setting-title">全局装扮预设</span>
                <div id="theme-list" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>

            <div class="setting-row">
                <span class="setting-title">高级自定义 (全局颜色)</span>
                <textarea id="custom-code" class="code-editor" placeholder="请点击下方按钮获取模板..."></textarea>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <button class="btn-outline" style="flex:1" onclick="generateThemeCode()">获取当前配色代码</button>
                    <button class="btn-block" style="flex:1; margin-top:5px;" onclick="applyCustomTheme()">应用自定义代码</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-title">全局美化 & 气泡自定义 (CSS)</span>
                <textarea id="custom-css" class="code-editor" placeholder="在此输入自定义 CSS 代码..."></textarea>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <button class="btn-outline" style="flex:1" onclick="insertBubbleTemplate()">插入气泡模板</button>
                    <button class="btn-block" style="flex:1; margin-top:5px;" onclick="applyCustomCSS()">应用 CSS</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-title">个性化微调</span>
                <div style="display:flex;gap:10px;margin-bottom:10px;">
                    <label>字体大小 <input type="range" min="12" max="24" oninput="updateStyle('size',this.value)"></label>
                </div>
                <label style="display:flex;justify-content:space-between;margin-bottom:5px;">
                    显示头像 <input type="checkbox" id="chk-avatar" onchange="updateStyle('avatar', this.checked)">
                </label>
                <label style="display:flex;justify-content:space-between;">
                    显示悬浮窗 <input type="checkbox" id="chk-float" onchange="updateStyle('float', this.checked)">
                </label>
            </div>

            <div class="setting-row">
                <span class="setting-title">背景设置</span>
                <input type="file" id="file-bg" hidden accept="image/*">
                <button class="btn-outline" onclick="document.getElementById('file-bg').click()">上传壁纸</button>
                <button class="btn-outline" style="color:#999;border-color:#ccc" onclick="updateStyle('bg', '')">移除壁纸</button>
            </div>

            <div class="setting-row">
                <span class="setting-title">悬浮窗图标</span>
                <input type="file" id="file-float" hidden accept="image/*">
                <button class="btn-outline" onclick="document.getElementById('file-float').click()">自定义图标</button>
            </div>

            <button class="btn-block" onclick="saveSettings()">保存配置</button>
        </div>
    </div>

    <div id="modal-player" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>播放器</h3><i class="ph ph-x" onclick="closeAllModals()"></i></div>
            <div class="player-avatars" style="display:flex;justify-content:center;gap:30px;margin-bottom:20px;">
                <div style="text-align:center" onclick="changeAvatar('other')"><img id="p-av-other" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--c-theme)"><br><span style="font-size:12px">对方</span></div>
                <div style="text-align:center" onclick="changeAvatar('self')"><img id="p-av-self" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--c-theme)"><br><span style="font-size:12px">我</span></div>
            </div>
            <div class="vinyl" id="vinyl"><img src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=300"></div>
            <div style="text-align:center;margin:10px;font-weight:bold" id="song-name">未播放</div>
            <div style="display:flex;justify-content:center;font-size:40px;cursor:pointer" onclick="toggleMusic()"><i class="ph-play-circle" id="btn-play"></i></div>
            <input type="file" id="file-audio" hidden accept="audio/*">
            <button class="btn-outline" onclick="document.getElementById('file-audio').click()">上传本地音乐</button>
            <div style="margin-top:10px">
                <input type="text" id="search-key" placeholder="搜歌..." style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px">
                <button class="btn-block" style="margin-top:5px" onclick="searchMusic()">搜索</button>
                <div id="search-res" style="margin-top:5px"></div>
            </div>
        </div>
    </div>

    <div id="modal-replies" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>词条库</h3><i class="ph ph-x" onclick="closeAllModals()"></i></div>
            <div style="display:flex;gap:5px;">
                <input type="text" id="new-reply" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px" placeholder="新回复...">
                <button onclick="addReply()" style="padding:0 10px;">+</button>
            </div>
            <div id="reply-list" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>
            <div style="margin-top:10px;display:flex;gap:10px;">
                <button class="btn-outline" onclick="exportData()">导出</button>
                <input type="file" id="file-import" hidden onchange="importData(this)">
                <button class="btn-outline" onclick="document.getElementById('file-import').click()">导入</button>
            </div>
        </div>
    </div>

    <div id="modal-sessions" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>会话管理</h3><i class="ph ph-x" onclick="closeAllModals()"></i></div>
            <div style="display:flex;gap:5px;margin-bottom:10px;">
                <input type="text" id="new-sess" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:4px" placeholder="会话名">
                <button onclick="addSession()">新建</button>
            </div>
            <div id="sess-list"></div>
        </div>
    </div>

    <input type="file" id="file-av" hidden accept="image/*">
    <audio id="bgm"></audio>

    <script>
        /* =================================================================
           【模块：JS 逻辑】
           ================================================================= */
        const KEY = 'chat_v10_beautify_fixed';
        const audio = document.getElementById('bgm');
        
        const PRESETS = [
            { id: 'default', name: '经典原味 (默认)', colors: { theme: '#E24B2A', bgMain: '#FFFAE4', bgSub: '#F3EDD1', textMain: '#0F1616', textSub: '#556F59', border: 'rgba(0,0,0,0.1)', icon: '#556F59', meBg: '#E24B2A', meText: '#ffffff', otherBg: '#ffffff', otherText: '#000000', inputBg: '#ffffff' } },
            { id: 'ocean', name: '深海乳酪三重奏', colors: { theme: '#0147A6', bgMain: '#3b3c50', bgSub: '#3b3c50', textMain: '#feffef', textSub: '#0147A6', border: 'rgba(0,0,0,0.2)', icon: '#0147A6', meBg: '#0147A6', meText: '#feffef', otherBg: '#feffef', otherText: '#0147A6', inputBg: 'rgba(0,0,0,0.2)' } },
            { id: 'lemon', name: '蓝莓柠檬乳酪塔', colors: { theme: '#022BAB', bgMain: '#F6F9DC', bgSub: '#F6F9DC', textMain: '#022BAB', textSub: '#FBD35A', border: '#022BAB', icon: '#FBD35A', meBg: '#022BAB', meText: '#F6F9DC', otherBg: '#FBD35A', otherText: '#022BAB', inputBg: '#ffffff' } },
            { id: 'sakura', name: '樱抹青柠奶盖塔', colors: { theme: '#CAE691', bgMain: '#FFFEF3', bgSub: '#FFFEF3', textMain: '#556F59', textSub: '#A6C972', border: '#CAE691', icon: '#FFFEF3', meBg: '#CAE691', meText: '#FFFEF3', otherBg: '#A6C972', otherText: '#FFFEF3', inputBg: '#ffffff' } }
        ];

        // --- 完整内置词库 ---
        const BUILTIN_REPLIES = [
            "有点无聊","好无聊啊","太无聊了","不知道干嘛","发呆中","闲着没事","找点事做","不想出门","无所事事","有点没劲","没什么意思","好开心","超开心","太开心了","心情很好","心情不错","有点小开心","今天超顺利","好事发生了","太惊喜了","满心欢喜","真的好快乐","好幸福","幸福感满满","意外的开心","快乐加倍","心情舒畅","轻松又愉快","有点累","有点疲惫","不太想动","想歇一歇","想安静会儿","懒得说话","只想躺着","需要休息","状态一般","没什么力气","不想动脑","不想费神","有点心累","情绪不高","提不起精神","不太想说话","在干嘛呀？","吃饭了吗？","下班了吗？","放学了吗？","刚忙完","马上就好","稍等我一下","马上回来","我来了","我在哦","好久不见","最近忙什么呢？","有空一起玩","出来玩吗？","在家待着","有点懒","准备出门","外面人好多","今天好热啊","今天好冷啊","风好大","好像要下雨","出太阳了","心情好好","有点不开心","安慰我一下","没事就好","吓死我了","真的假的？","太离谱了","太搞笑了","绝了","厉害厉害","佩服佩服","可以可以","太会了","不错不错","还行吧","一般般","算了算了","没事没事","别管了","别在意","别放心上","我懂我懂","我理解","太不容易了","真的辛苦","抱抱你","太惨了","好可怜","好心疼","太棒了吧","太牛了","绝绝子","好好看","好好听","好好闻","太香了","好吃","好喝","爱了爱了","喜欢喜欢","超喜欢","很喜欢","我也喜欢","我也是","对的对的","没错没错","就是就是","确实如此","我也觉得","我也想","我也要","带我一个","等等我","别急别急","慢慢慢","小心点","注意点","别乱跑","别乱买","早点回家","注意安全","到家告诉我","晚安晚安","好梦哦","盖好被子","别踢被子","早点睡吧","别熬夜了","熬夜不好","快睡觉","醒了吗？","还没醒？","刚醒","好困啊","想睡觉","不想起床","再睡一会","上班好困","上课好困","好累啊","歇一会","躺一会","充充电","聊聊天吧","说说话","讲个故事","讲个笑话","笑死我了","哈哈哈哈哈哈","太逗了","有趣","有意思","好神奇","好厉害啊","好棒啊","好乖啊","好萌啊","好软啊","好甜啊","好治愈啊","好温暖啊","好舒服啊","好安心啊","好幸福啊","好满足啊","好开心啊","好快乐啊","好轻松啊","好自在啊","好安静啊","好热闹啊","好温馨啊","好浪漫啊","好精致啊","好简约啊","好好用啊","好方便啊","好实惠啊","好划算啊","好便宜啊","好贵啊","好小啊","好大啊","好长啊","好短啊","好快啊","好慢啊","好早啊","好晚啊","好多啊","好少啊","好远啊","好近啊","好高啊","好矮啊","好厚啊","好薄啊","好软啊","好硬啊","好滑啊","好亮啊","好暗啊","好美啊","好帅啊","好可爱啊","好温柔啊","好酷啊","好飒啊","好仙啊","好稳啊","好急啊","好慌啊","好紧张啊","好激动啊","好兴奋啊","好期待啊","好惊喜啊","好意外啊","好感动啊","好心疼啊","好难过啊","好委屈啊","好生气啊","好烦躁啊","好焦虑啊","好迷茫啊","好孤单啊","好寂寞啊","好难受啊","好尴尬啊","好害羞啊","好不好意思","在干嘛呢？","吃饭了没有？","今天过得好吗？","下班啦！","放学啦！","刚忙完事情","马上就好了","我马上回来","我来啦！","我一直都在","好久没见啦","最近过得如何？","有空一起出去玩","今天不想出门","在家休息呢","准备出门啦","今天天气好热","今天天气好冷","外面风很大","好像要下雨了","太阳出来啦","心情超级好","有点不开心","安慰安慰我吧","没事就太好了","真的假的呀？","这也太搞笑了","这也太厉害了","太绝了吧！","佩服佩服！","可以可以！","不错不错！","还行吧一般","算了算了","别太在意啦","我完全懂你","真的太不容易","抱抱你呀","好心疼你哦","也太香了吧","真的很好吃","真的很好喝","我也超喜欢","我也是这样","对的对的！","没错没错！","我也是这么想","等等我呀！","别急别急！","小心一点哦","早点回家啦","到家记得说","晚安好梦哦","盖好被子啦","醒了没有呀？","刚睡醒呢","好困好困","不想起床啊","上班好累啊","上课好累啊","休息一下吧","躺平一会儿","好无聊啊","陪我聊聊天","笑死我了！","这也太有趣了","好神奇啊！","好温柔啊！","好治愈啊！","好温暖啊！","好幸福啊！","好开心啊！","好舒服啊！","好安静啊！","好浪漫啊！","这也太好用了","这也太方便了","好划算啊！","好贵啊！","好大啊！","好小啊！","好快啊！","好慢啊！","好早啊！","好晚啊！","好美啊！","好帅啊！","好可爱啊！","好酷啊！","好激动啊！","好期待啊！","好惊喜啊！","好感动啊！","好委屈啊！","好烦躁啊！","好孤单啊！","好疲惫啊！","好尴尬啊！","好害羞啊！","有点不好意思","一切都会过去","收到","已读","好的","明白了","了解","清楚","确认","知道了","可以","不行","同意","不同意","没问题","稍等","稍后","马上","尽快","正在处理","完成了","进行中","暂停了","取消了","结束了","开始了","准备好了","请注意","提醒一下","记得查看","记得回复","有空回复","不急","慢慢来","不用急","再说","再看","再议","下次","回头说","当面说","电话说","微信说","文字说","发我一下","发我文件","发我截图","发我地址","发我时间","发我资料","收到请回","收到回复","核对一下","检查一下","修改一下","调整一下","补充一下","完善一下","记录一下","保存一下","同步一下","沟通一下","商量一下","确认一下","落实一下","安排一下","处理一下","解决一下","反馈一下","汇报一下","说明一下","解释一下","简单说下","直接说吧","重点说下","还有问题吗","还有疑问吗","还有补充吗","没有了","就这样","按计划来","按要求做","按步骤来","正常进行","一切正常","状态正常","时间到了","该出发了","已出发","已到达","已回家","已休息","在忙","没空","稍后联系","现在不方便","有空再聊","先不聊了","有事先忙","有事留言","再见","晚安","无聊透顶","打发时间","没人聊天","今天好开心","莫名开心","开心到冒泡","太幸福了","觉得很幸福","生活很美好","一切都很好","越想越好笑","提不起兴趣","平平无奇","就这样吧","随便逛逛","消磨时间","安静待着","真不错","太好了","太棒啦","完美","很满意","超满意","顺顺利利","开开心心","轻轻松松","有点困","有点乏","有点倦","精神一般","缓一缓就好","睡一觉就好","放松一下","好治愈","好温暖","很舒心","很自在","很安心","很平静","很踏实","很满足","很惬意","很舒服","没什么情绪","情绪很淡","普普通通","日常而已","正常就好","平安就好","简单就好","快乐就好","好好生活","慢慢来吧","只想自己待着","哈哈哈哈","太好笑了","真的有趣","好有意思",
            "(｡>﹏<｡)", "ヾ(≧▽≦*)o", "(๑•̀ㅂ•́)و✧", "ヽ(○´∀`)ノ", "(◕‿◕✿)", "(｡‿｡)", "(*^ω^*)", "(￣3￣)a", "Σ(っ °Д °;)っ", "(ﾉ≧∀≦)ﾉ", "(´;ω;`)", "٩(ˊᗜˋ*)و", "(。-`ω´-)", "(￣▽￣)~*", "(づ｡◕‿‿◕｡)づ", "(￣ω￣)", "╮(╯_╰)╭", "(￣へ￣)", "└(^o^┘)", "(￣ー￣)", "ヽ(｀⌒´)ﾉ", "(￢_￢)", "(つ°ω°)つ", "(*￣m￣)", "ᕙ(`▿´)ᕗ", "（￣□￣；）", "Σ( ° △ °|||)︴", "(-_-#)", "（゜ロ゜）", "┐(‘～`；)┌", "￣□￣｜｜", "（＃－.－）", "（￣ー￣）", "（⊙.⊙）", "（￣ω￣）", "Σ(っ °Д °;)っ", "Σ(っ°Д°;)っ", "Σ(ﾟдﾟ;)", "Σ(☉▽☉\";)", "Σ(っД;)っ", "Σ(っ°Д°;)", "Σ( ﾟﾛﾟ)", "Σ( ﾟωﾟ)", "Σ( ° ω °)", "Σ( ° △ °)", "(〃'▽'〃)", "(〃∀〃)", "(〃'▽'〃)", "(*꒦ູ⌓꒦ູ*)", "(„ಡωಡ„)", "(●´৺`)", "(〃ﾉωﾝ)", "(〃｀Δ´)", "(〃ﾉω､)", "(〃｀Δ´〃)", "(￣＿￣)", "ヽ(￣д￣;)ノ", "(￣ー￣)", "┌∩┐(ಠ_ಠ)┌∩┐", "(｀･ω･´)", "(￣ω￣)", "(｀∇´)", "(＾◡＾)", "(￣～￣)", "( ・ิω・ิ)", "ヽ(★ω★)ノ", "Σ(っ∀っ)", "ヽ(≧Д≦)ノ", "Σ(✪ω✪)", "ヽ(ﾟДﾟ)/", "Σ(°△°;", "ヽ(｀ω´)/", "Σ(▼皿▼#)", "ヽ(｀⌒')ノ", "Σ(っ°ω°;)っ", "(T_T)", "(ಥ_ಥ)", "(╥﹏╥)", "(;_;)", "(×_×)", "ヽ( ￣д￣;)ノ", "(-`ω '-')", "(¬‿¬)", "¯\\_(ツ)_/¯", "(눈_눈)", "(-_-) zZ", "(￣﹏￣)", "～(￣▽￣～)", "(￣o￣) . z Z", "(－＂－)"
        ];

        let data = {
            config: {
                currentThemeId: 'default',
                colors: PRESETS[0].colors,
                size: 16, showAvatar: true, showFloat: true, bg: '', floatIcon: 'https://api.dicebear.com/7.x/identicon/svg?seed=Music',
                patSelf: '拍了拍', patOther: '摸了摸',
                customCSS: '' 
            },
            sessions: { 'def': { name: '默认会话', msgs: [] } },
            curSess: 'def',
            user: { name: '我', av: 'https://api.dicebear.com/7.x/avataaars/svg?seed=A', desc: '' },
            other: { name: '对方', av: 'https://api.dicebear.com/7.x/avataaars/svg?seed=B', desc: '' },
            replies: BUILTIN_REPLIES // 默认使用完整词库
        };
        
        let tempAvType = '';
        let currentEditingRole = '';

        window.onload = () => {
            const hideSplash = () => document.getElementById('splash').classList.add('hidden');
            setTimeout(hideSplash, 3000); 

            try {
                const local = localStorage.getItem(KEY);
                if(local) {
                    try { 
                        const p = JSON.parse(local);
                        data = { ...data, ...p, config: {...data.config, ...p.config} };
                        
                        // 【强制更新逻辑】：确保内置词汇被加入
                        // 将本地存储的词汇和内置词汇合并，并去重
                        const mergedReplies = [...new Set([...BUILTIN_REPLIES, ...(p.replies || [])])];
                        data.replies = mergedReplies;
                        
                        if(data.config.customCSS === undefined) data.config.customCSS = '';
                    } catch(e) { console.error(e); }
                }
                
                initUI();
                renderThemeList();
                updateHeaderTitle();
                const cssInput = document.getElementById('custom-css');
                if(cssInput) cssInput.value = data.config.customCSS || '';
                setTimeout(hideSplash, 1500);
            } catch (err) {
                console.error(err);
                hideSplash();
            }
        };

        function save() { localStorage.setItem(KEY, JSON.stringify(data)); }

        // --- UI & 装扮 ---
        function initUI() {
            const c = data.config.colors;
            const root = document.documentElement.style;
            
            root.setProperty('--c-theme', c.theme);
            root.setProperty('--c-bg-main', c.bgMain);
            root.setProperty('--c-bg-sub', c.bgSub);
            root.setProperty('--c-text-main', c.textMain);
            root.setProperty('--c-text-sub', c.textSub);
            root.setProperty('--c-border', c.border);
            root.setProperty('--c-icon', c.icon);
            
            root.setProperty('--bubble-me-bg', c.meBg);
            root.setProperty('--bubble-me-text', c.meText);
            root.setProperty('--bubble-other-bg', c.otherBg);
            root.setProperty('--bubble-other-text', c.otherText);
            root.setProperty('--input-bg', c.inputBg);

            root.setProperty('--bg-image', data.config.bg ? `url(${data.config.bg})` : 'none');
            document.body.style.fontSize = data.config.size + 'px';
            document.body.classList.toggle('hide-avatars', !data.config.showAvatar);
            
            document.getElementById('float-img').src = data.config.floatIcon;
            document.getElementById('music-float').style.display = (data.config.showFloat && !audio.paused) ? 'flex' : 'none';
            document.getElementById('chk-avatar').checked = data.config.showAvatar;
            document.getElementById('chk-float').checked = data.config.showFloat;
            
            renderCustomCSS();
            updateAvatars();
            updateHeaderTitle();
            renderChat();
        }

        // --- CSS 自定义功能 ---
        function applyCustomCSS() {
            const css = document.getElementById('custom-css').value;
            data.config.customCSS = css;
            renderCustomCSS();
            save();
            alert('美化已应用！');
        }

        function renderCustomCSS() {
            let styleTag = document.getElementById('user-custom-style');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'user-custom-style';
                document.head.appendChild(styleTag);
            }
            styleTag.innerHTML = data.config.customCSS || '';
        }

        function insertBubbleTemplate() {
            const tpl = `/* --- 气泡美化模板 --- */
/* 我方气泡 */
.message-row.right .bubble {
    border-radius: 20px 20px 0 20px;
    background: linear-gradient(135deg, var(--c-theme), #ff9a9e);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* 对方气泡 */
.message-row.left .bubble {
    border-radius: 20px 20px 20px 0;
    border: 1px solid var(--c-theme);
}

/* 全局背景特效示例 */
#app {
    backdrop-filter: blur(5px);
}`;
            document.getElementById('custom-css').value = tpl;
        }

        // --- 角色/个人信息逻辑 ---
        function openRoleInfo(role) {
            currentEditingRole = role;
            const target = role === 'self' ? data.user : data.other;
            
            document.getElementById('role-title').innerText = role === 'self' ? '个人信息 (我)' : '角色信息 (对方)';
            document.getElementById('role-name').value = target.name;
            document.getElementById('role-desc').value = target.desc || '';
            document.getElementById('role-av-img').src = target.av;
            
            document.getElementById('modal-role').style.display = 'flex';
            closeAllModals(false); 
        }

        function changeRoleAvatar() {
            changeAvatar(currentEditingRole);
        }

        function saveRoleInfo() {
            const name = document.getElementById('role-name').value;
            const desc = document.getElementById('role-desc').value;
            
            if (currentEditingRole === 'self') {
                data.user.name = name || '我';
                data.user.desc = desc;
            } else {
                data.other.name = name || '对方';
                data.other.desc = desc;
            }
            
            save();
            updateHeaderTitle();
            document.getElementById('modal-role').style.display = 'none';
            alert('保存成功');
        }

        function updateHeaderTitle() {
            const title = data.other.name || '对方';
            document.getElementById('header-quote').innerText = title;
        }

        // --- 自定义配色代码功能 ---
        function generateThemeCode() {
            const c = data.config.colors;
            const tpl = `/* --- 全局自定义配色代码 --- */
/* 使用说明：修改冒号后面的颜色代码即可 (支持 #hex, rgb, rgba, 英文颜色名) */

theme:      ${c.theme}      /* 主题色 (按钮/我方气泡/强调色) */
bgMain:     ${c.bgMain}     /* 网页背景颜色 */
bgSub:      ${c.bgSub}      /* 弹窗/菜单背景 */
textMain:   ${c.textMain}   /* 主要文字颜色 */
textSub:    ${c.textSub}    /* 次要文字颜色 */
border:     ${c.border}     /* 线条边框颜色 */
icon:       ${c.icon}       /* 小图标颜色 */

meBg:       ${c.meBg}       /* 我方气泡背景 */
meText:     ${c.meText}     /* 我方气泡文字 */
otherBg:    ${c.otherBg}    /* 对方气泡背景 */
otherText:  ${c.otherText}  /* 对方气泡文字 */

inputBg:    ${c.inputBg}    /* 输入框背景 */`;
            
            document.getElementById('custom-code').value = tpl;
        }

        function applyCustomTheme() {
            const code = document.getElementById('custom-code').value;
            if(!code.trim()) return alert('请先获取代码或输入代码！');
            
            const lines = code.split('\n');
            const newColors = { ...data.config.colors };
            
            lines.forEach(line => {
                const cleanLine = line.split('/*')[0].trim();
                if(cleanLine.includes(':')) {
                    const [key, val] = cleanLine.split(':').map(s => s.trim());
                    if(key && val && newColors.hasOwnProperty(key)) {
                        newColors[key] = val;
                    }
                }
            });
            
            data.config.colors = newColors;
            data.config.currentThemeId = 'custom';
            initUI();
            save();
            renderThemeList();
            alert('自定义装扮已应用！');
        }

        function renderThemeList() {
            const list = document.getElementById('theme-list');
            list.innerHTML = PRESETS.map(p => `
                <div class="theme-preset-item ${data.config.currentThemeId === p.id ? 'active' : ''}" onclick="applyPreset('${p.id}')">
                    <div class="color-preview">
                        <div class="cp-slice" style="background:${p.colors.theme}"></div>
                        <div class="cp-slice" style="background:${p.colors.bgMain}"></div>
                        <div class="cp-slice" style="background:${p.colors.meBg}"></div>
                    </div>
                    <span>${p.name}</span>
                </div>
            `).join('');
        }

        function applyPreset(id) {
            const preset = PRESETS.find(p => p.id === id);
            if(preset) {
                data.config.currentThemeId = id;
                data.config.colors = preset.colors;
                initUI(); 
                renderThemeList(); 
                save();
                generateThemeCode();
            }
        }

        function updateStyle(key, val) {
            data.config[key] = val;
            initUI();
        }
        function saveSettings() { save(); closeAllModals(); alert('保存成功'); }

        // --- 聊天 ---
        function updateAvatars() {
            ['head-av-self','p-av-self'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.src = data.user.av;
            });
            ['head-av-other','p-av-other'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.src = data.other.av;
            });
            
            if(currentEditingRole === 'self') {
                document.getElementById('role-av-img').src = data.user.av;
            } else if(currentEditingRole === 'other') {
                document.getElementById('role-av-img').src = data.other.av;
            }
        }

        function renderChat() {
            const list = document.getElementById('msg-list');
            list.innerHTML = '';
            const msgs = data.sessions[data.curSess].msgs || [];
            
            msgs.forEach(m => {
                const div = document.createElement('div');
                if(m.type === 'sys') {
                    div.className = 'system-msg'; div.innerText = m.text;
                } else {
                    div.className = `message-row ${m.self?'right':'left'}`;
                    const av = m.self ? data.user.av : data.other.av;
                    const clickAction = m.self ? `onclick="openRoleInfo('self')"` : `onclick="doPat()"`; 
                    let content = m.text;
                    if(m.type==='img') content = `<img src="${m.text}" onclick="window.open(this.src)">`;
                    const readHtml = (m.self && m.read) ? `<span class="read-mark visible">已读</span>` : `<span class="read-mark"></span>`;
                    div.innerHTML = `
                        <img class="chat-avatar" src="${av}" ${clickAction}>
                        <div class="bubble-container">
                            <div class="bubble">${content}</div>
                            <div class="meta-info">${readHtml} ${new Date(m.time).toTimeString().substr(0,5)}</div>
                        </div>
                    `;
                }
                list.appendChild(div);
            });
            list.parentElement.scrollTop = list.parentElement.scrollHeight;
        }

        function sendMsg() {
            const el = document.getElementById('msg-input');
            const txt = el.value.trim();
            if(!txt) return;
            addMsg({text:txt, type:'text', self:true, read:false});
            el.value='';
        }
        function addMsg(m) {
            m.time = Date.now();
            data.sessions[data.curSess].msgs.push(m);
            save(); renderChat();
        }

        function autoReply() {
            if(!data.replies.length) return alert('词条库空空如也');
            
            const tip = document.getElementById('typing-tip');
            const headerTitle = document.getElementById('header-quote');
            const originalTitle = headerTitle.innerText; 
            
            tip.style.display = 'block';
            headerTitle.innerText = '对方正在输入...';
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
            
            setTimeout(() => {
                tip.style.display = 'none';
                headerTitle.innerText = originalTitle; 
                
                const msgs = data.sessions[data.curSess].msgs;
                for(let i=msgs.length-1; i>=0; i--) { if(msgs[i].self){ msgs[i].read=true; break; } }
                
                const count = Math.floor(Math.random()*5)+1;
                let delay = 0;
                for(let i=0; i<count; i++) {
                    delay += Math.random()*600+600;
                    setTimeout(() => {
                        addMsg({ text: data.replies[Math.floor(Math.random()*data.replies.length)], type: 'text', self:false });
                    }, delay);
                }
                if(Math.random()<0.3) {
                    setTimeout(() => {
                        addMsg({ text: `"${data.other.name}" ${data.config.patOther} "${data.user.name}"`, type: 'sys' });
                    }, delay+1000);
                }
            }, 1500);
        }

        function doPat() {
            addMsg({ text: `"${data.user.name}" ${data.config.patSelf} "${data.other.name}"`, type: 'sys' });
            if(Math.random()<0.4) setTimeout(() => {
                addMsg({ text: `"${data.other.name}" ${data.config.patOther} "${data.user.name}"`, type: 'sys' });
            }, 1500);
        }

        // --- 音乐 ---
        function toggleMusic() {
            const btn = document.getElementById('btn-play');
            const vinyl = document.getElementById('vinyl');
            const float = document.getElementById('music-float');
            if(audio.paused) {
                audio.play(); vinyl.classList.add('playing'); btn.className='ph-fill ph-pause-circle btn-ctrl';
                if(data.config.showFloat) float.style.display='flex';
            } else {
                audio.pause(); vinyl.classList.remove('playing'); btn.className='ph-fill ph-play-circle btn-ctrl';
                float.style.display='none';
            }
        }
        const fakeLib = [{n:"晴天 - 周杰伦",u:"https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3"},{n:"十年 - 陈奕迅",u:"https://cdn.pixabay.com/download/audio/2022/03/24/audio_3441a1532c.mp3"}];
        function searchMusic() { document.getElementById('search-res').innerHTML = fakeLib.map(s=>`<div style="padding:5px;border-bottom:1px solid #eee;cursor:pointer" onclick="playUrl('${s.u}','${s.n}')">${s.n}</div>`).join(''); }
        function playUrl(u,n) { audio.src=u; document.getElementById('song-name').innerText=n; toggleMusic(); }

        // --- 弹窗与文件 ---
        function openMenu() { document.getElementById('modal-menu').style.display = 'block'; }
        function openPlayer() { document.getElementById('modal-player').style.display = 'flex'; }
        function openSettings() { document.getElementById('modal-settings').style.display = 'flex'; }
        function openSessions() { document.getElementById('modal-sessions').style.display = 'flex'; renderSessions(); }
        function openReplies() { document.getElementById('modal-replies').style.display = 'flex'; renderReplies(); }
        
        function closeAllModals(closeRole = true) { 
            const modals = document.querySelectorAll('.modal');
            modals.forEach(m => {
                if (!closeRole && m.id === 'modal-role') return;
                m.style.display = 'none';
            });
            document.getElementById('action-menu').classList.remove('show'); 
        }
        
        function toggleMenu() { document.getElementById('action-menu').classList.toggle('show'); document.getElementById('btn-plus').classList.toggle('rotate'); }

        function triggerUpload(t) { if(t==='img') document.getElementById('file-img').click(); }
        
        function changeAvatar(t) { 
            if(t) tempAvType = t; 
            else if(currentEditingRole) tempAvType = currentEditingRole;
            document.getElementById('file-av').click(); 
        }
        
        document.getElementById('file-img').onchange = e => compress(e.target.files[0], 800, r=>{ addMsg({text:r,type:'img',self:true}); closeAllModals(); });
        document.getElementById('file-bg').onchange = e => compress(e.target.files[0], 1200, r=>updateStyle('bg',r));
        document.getElementById('file-float').onchange = e => compress(e.target.files[0], 200, r=>updateStyle('floatIcon',r));
        
        document.getElementById('file-av').onchange = e => compress(e.target.files[0], 300, r=>{
            if(tempAvType==='self' || tempAvType==='user') {
                data.user.av = r;
            } else {
                data.other.av = r;
            }
            save(); 
            updateAvatars(); 
            renderChat();
        });
        
        document.getElementById('file-audio').onchange = e => { const f=e.target.files[0]; if(f){audio.src=URL.createObjectURL(f); document.getElementById('song-name').innerText=f.name; toggleMusic();} };

        function compress(f,w,cb) {
            if(!f) return; const r=new FileReader();
            r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{
                const c=document.createElement('canvas'); const s=w/i.width; c.width=w; c.height=i.height*s;
                c.getContext('2d').drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/jpeg',0.8));
            }}; r.readAsDataURL(f);
        }

        // --- 会话/词条/导出 ---
        function renderReplies() { document.getElementById('reply-list').innerHTML = data.replies.map((t,i)=>`<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between">${t} <span style="color:red;cursor:pointer" onclick="data.replies.splice(${i},1);save();renderReplies()">×</span></div>`).join(''); }
        function addReply() { const v=document.getElementById('new-reply').value; if(v){data.replies.push(v);save();renderReplies();} }
        function renderSessions() { document.getElementById('sess-list').innerHTML = Object.keys(data.sessions).map(k=>`<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;${k===data.curSess?'background:#f5f5f5':''}" onclick="data.curSess='${k}';save();closeAllModals();renderChat()"><span>${data.sessions[k].name}</span></div>`).join(''); }
        function addSession() { const n=document.getElementById('new-sess').value; if(n){data.sessions['s'+Date.now()]={name:n,msgs:[]};save();renderSessions();} }
        function clearChat() { if(confirm('清空?')){data.sessions[data.curSess].msgs=[];save();renderChat();} }
        function exportData() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download='backup.json'; document.body.appendChild(a); a.click(); }
        
        // --- 修复后的智能导入函数 ---
        function importData(e) {
            const file = e.files[0];
            if (!file) return;
            
            const r = new FileReader();
            r.onload = ev => {
                const content = ev.target.result;
                let isSuccess = false;

                try {
                    const json = JSON.parse(content);
                    if (Array.isArray(json)) {
                        data.replies = [...new Set([...data.replies, ...json])];
                        save();
                        renderReplies();
                        alert(`成功导入 ${json.length} 条词汇！`);
                        isSuccess = true;
                    } else if (typeof json === 'object' && json.config) {
                        data = json;
                        save();
                        location.reload();
                        isSuccess = true;
                    }
                } catch (err) {}

                if (!isSuccess) {
                    const matches = content.match(/"(.*?)"/g);
                    if (matches && matches.length > 0) {
                        const newWords = matches.map(s => s.replace(/"/g, ''));
                        data.replies = [...new Set([...data.replies, ...newWords])];
                        save();
                        renderReplies();
                        alert(`智能识别成功！已导入 ${newWords.length} 条词汇。`);
                        isSuccess = true;
                    }
                }

                if (!isSuccess) {
                    alert('导入失败：无法识别文件内容。');
                }
                e.value = ''; 
            };
            r.readAsText(file);
        }
    </script>
</body>
</html>
